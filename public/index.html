<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vexx - App de Gestão de Produção</title>
    
    <!-- Tailwind CSS para um design moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos CSS customizados para o tema Dark Blue (Light) -->
    <style>
        /* Define a fonte Inter e o tema escuro como padrão */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e293b; /* Fundo azul-ardósia principal */
            color: #e2e8f0; /* Cor de texto padrão (cinza claro) */
        }

        /* Classes para transições suaves */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        
        /* Estilo para a aba ativa na navegação */
        .nav-link.active {
            background-color: #3b82f6; /* Azul destacado */
            color: #ffffff;
            font-weight: 600;
        }

        .nav-link:hover {
            background-color: #334155; /* Fundo mais escuro no hover */
        }
        
        /* Oculta as abas de conteúdo por padrão */
        .tab-content {
            display: none;
        }

        /* Mostra a aba ativa */
        .tab-content.active {
            display: block;
        }
        
        /* Animação de entrada */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }

        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Estilização de Inputs para o tema dark */
        input, textarea, select {
            background-color: #0f172a;
            border-color: #475569;
            color: #e2e8f0;
        }
        input::placeholder, textarea::placeholder {
            color: #94a3b8;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #1e293b, 0 0 0 4px #3b82f6;
        }

        /* Estilo Toast (Notificações) */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            padding: 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show {
            opacity: 1;
            transform: scale(1);
        }
        .toast.success { background-color: #22c55e; } /* Verde */
        .toast.error { background-color: #ef4444; } /* Vermelho */
        .toast.info { background-color: #3b82f6; } /* Azul */
    </style>
</head>
<body class="text-gray-200">

    <!-- Estrutura principal com Sidebar e Conteúdo -->
    <div class="flex h-screen bg-[#1e293b]">
        
        <!-- Sidebar (Navegação) -->
        <aside class="w-64 bg-[#0f172a] border-r border-[#334155] flex-shrink-0 hidden md:flex md:flex-col">
            <div class="p-6 text-3xl font-bold text-white border-b border-[#334155]">
                Vexx
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <a href="#dashboard" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    Dashboard
                </a>
                <a href="#despesas" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 10v-1m0 0c-1.11 0-2.08-.402-2.599-1M9.401 15c-.519-.598-.9-1.49-.9-2.5s.381-1.902.9-2.5m5.198 5c.519-.598.9-1.49.9-2.5s-.381-1.902-.9-2.5"></path></svg>
                    Despesas
                </a>
                <a href="#insumos" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                    Insumos
                </a>
                <a href="#produtos" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                    Produtos
                </a>
                <a href="#producao" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Produção
                </a>
                <a href="#estoque" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                    Estoque
                </a>
            </nav>
            <div class="p-4 border-t border-[#334155]">
                 <a href="#perfil" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    Perfil
                </a>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">

            <button id="mobileMenuButton" class="md:hidden p-2 rounded-md bg-[#0f172a] border border-[#334155] mb-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            
            <!-- ABAS DE CONTEÚDO -->

            <!-- Dashboard -->
            <section id="dashboard" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white">Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-sm font-medium text-slate-400">Custo Mensal Total</h3>
                        <p id="dashboard-custo-total" class="text-3xl font-bold mt-2 text-white">R$ 0,00</p>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-sm font-medium text-slate-400">Produção do Mês</h3>
                        <p id="dashboard-producao-mes" class="text-3xl font-bold mt-2 text-white">0 unidades</p>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-sm font-medium text-slate-400">Receita Estimada</h3>
                        <p id="dashboard-receita-estimada" class="text-3xl font-bold mt-2 text-white">R$ 0,00</p>
                    </div>
                     <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-sm font-medium text-slate-400">Lucro Estimado</h3>
                        <p id="dashboard-lucro-estimado" class="text-3xl font-bold mt-2 text-green-400">R$ 0,00</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="font-semibold text-lg mb-4 flex items-center text-white">
                            <svg class="w-5 h-5 mr-2 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            Alertas de Estoque Baixo
                        </h3>
                        <div id="dashboard-alertas-estoque" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                         <h3 class="font-semibold text-lg mb-4 text-white">Produtos Mais Produzidos</h3>
                         <div id="dashboard-mais-produzidos" class="space-y-2"></div>
                    </div>
                </div>
            </section>

            <!-- Despesas -->
            <section id="despesas" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white">Gestão de Despesas</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-white">Custos Fixos</h2>
                        <form id="form-custo-fixo">
                            <input type="text" id="fixo-nome" placeholder="Nome da despesa (ex: Aluguel)" class="w-full p-2 border rounded-md mb-2" required>
                            <input type="number" id="fixo-valor" step="0.01" placeholder="Valor (R$)" class="w-full p-2 border rounded-md mb-4" required>
                            <button type="submit" class="w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Adicionar</button>
                        </form>
                        <div id="lista-custos-fixos" class="mt-6 space-y-2"></div>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-white">Custos Variáveis</h2>
                        <form id="form-custo-variavel">
                             <input type="text" id="variavel-nome" placeholder="Nome da despesa (ex: Água)" class="w-full p-2 border rounded-md mb-2" required>
                            <input type="number" id="variavel-valor" step="0.01" placeholder="Valor (R$)" class="w-full p-2 border rounded-md mb-4" required>
                            <button type="submit" class="w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Adicionar</button>
                        </form>
                        <div id="lista-custos-variaveis" class="mt-6 space-y-2"></div>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-white">Outras Despesas (%)</h2>
                        <form id="form-custo-percentual">
                             <input type="text" id="percentual-nome" placeholder="Nome (ex: Taxa do Marketplace)" class="w-full p-2 border rounded-md mb-2" required>
                            <input type="number" id="percentual-valor" step="0.01" placeholder="Valor (%)" class="w-full p-2 border rounded-md mb-4" required>
                            <button type="submit" class="w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Adicionar</button>
                        </form>
                        <div id="lista-custos-percentuais" class="mt-6 space-y-2"></div>
                    </div>
                </div>
                 <div class="mt-6 bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                    <h2 class="text-2xl font-bold text-white">Custo Total Mensal: <span id="custo-total-mensal" class="text-blue-400">R$ 0,00</span></h2>
                    <p class="text-slate-400 text-sm">Este valor é uma estimativa baseada nos seus custos fixos e variáveis.</p>
                </div>
            </section>

            <!-- Insumos -->
            <section id="insumos" class="tab-content">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <h1 class="text-3xl font-bold text-white">Cadastro de Insumos</h1>
                    <div>
                        <input type="file" id="importar-insumos-nf" class="hidden">
                        <label for="importar-insumos-nf" class="cursor-pointer bg-green-600 text-white p-2.5 rounded-md font-semibold text-sm hover:bg-green-700 transition-all">Importar de NF</label>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-[#0f172a] border border-[#334155] p-6 rounded-xl h-fit">
                        <h2 class="text-xl font-semibold mb-4 text-white">Novo Insumo</h2>
                        <form id="form-insumo">
                            <input type="hidden" id="insumo-id">
                            <input type="text" id="insumo-nome" placeholder="Nome do insumo" class="w-full p-2 border rounded-md mb-2" required>
                            <textarea id="insumo-desc" placeholder="Descrição (opcional)" class="w-full p-2 border rounded-md mb-2 h-20"></textarea>
                            <input type="number" id="insumo-preco" step="0.01" placeholder="Preço do item (R$)" class="w-full p-2 border rounded-md mb-2" required>
                            <input type="number" id="insumo-estoque" step="0.001" placeholder="Qtd. em estoque" class="w-full p-2 border rounded-md mb-2" required>
                            <input type="text" id="insumo-unidade" placeholder="Unidade (ex: kg, L, un)" class="w-full p-2 border rounded-md mb-4" required>
                            <button type="submit" class="w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Salvar Insumo</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-white">Lista de Insumos</h2>
                        <div class="max-h-[60vh] overflow-y-auto">
                            <table class="w-full text-left">
                                <thead class="border-b border-[#334155]">
                                    <tr>
                                        <th class="p-2">Nome</th>
                                        <th class="p-2">Preço Unit.</th>
                                        <th class="p-2">Estoque</th>
                                        <th class="p-2">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-insumos"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
             <!-- Produtos -->
            <section id="produtos" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white">Cadastro de Produtos</h1>
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-[#0f172a] border border-[#334155] p-6 rounded-xl h-fit">
                        <h2 class="text-xl font-semibold mb-4 text-white">Novo Produto</h2>
                        <form id="form-produto">
                             <input type="hidden" id="produto-id">
                            <label class="block mb-4 text-center cursor-pointer">
                                <img id="produto-imagem-preview" src="https://placehold.co/600x400/0f172a/e2e8f0?text=Foto+do+Produto" class="w-full h-40 object-cover rounded-md bg-[#020617]">
                                <input type="file" id="produto-imagem" class="hidden" accept="image/*">
                                <span class="text-sm text-blue-400 mt-1 block">Clique para enviar uma foto</span>
                            </label>

                            <input type="text" id="produto-nome" placeholder="Nome do produto" class="w-full p-2 border rounded-md mb-2" required>
                            <textarea id="produto-desc" placeholder="Descrição do produto" class="w-full p-2 border rounded-md mb-2 h-20"></textarea>
                            
                            <div class="flex justify-between items-center mt-4">
                                <h3 class="font-semibold text-white">Insumos Utilizados</h3>
                                <button type="button" id="btn-abrir-calculadora" class="text-sm bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700">Calculadora</button>
                            </div>

                            <div id="produto-insumos-lista" class="space-y-2 my-2 max-h-40 overflow-y-auto p-2 border border-[#334155] rounded-md bg-[#1e293b]">
                                <p class="text-slate-400 text-sm">Nenhum insumo adicionado.</p>
                            </div>
                            <div class="flex gap-2">
                               <select id="select-insumo-para-produto" class="w-full p-2 border rounded-md"></select>
                               <input type="number" step="0.001" id="qtd-insumo-para-produto" placeholder="Qtd" class="w-24 p-2 border rounded-md">
                               <button type="button" id="btn-add-insumo-produto" class="bg-slate-600 text-slate-200 px-3 rounded-md font-bold hover:bg-slate-500">+</button>
                            </div>
                            
                            <h3 class="font-semibold mt-4 mb-2 text-white">Preço de Venda</h3>
                             <div class="p-3 bg-[#1e293b] border border-[#334155] rounded-md mb-2 text-sm">
                                Custo do Produto: <span id="produto-custo-calculado" class="font-bold">R$ 0,00</span>
                            </div>
                            <label class="block text-sm mb-1">Margem de Lucro (%)</label>
                            <input type="number" id="produto-margem-lucro" placeholder="ex: 100" class="w-full p-2 border rounded-md mb-2" required>
                             <div class="p-3 bg-green-900/50 border border-green-500/30 rounded-md text-green-300">
                                Preço Sugerido: <span id="produto-preco-sugerido" class="font-bold text-lg">R$ 0,00</span>
                            </div>

                            <button type="submit" class="mt-4 w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Salvar Produto</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-white">Meus Produtos</h2>
                        <div id="lista-produtos" class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[75vh] overflow-y-auto p-1"></div>
                    </div>
                </div>
            </section>

            <!-- Produção -->
            <section id="producao" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white">Registro de Produção</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-[#0f172a] border border-[#334155] p-6 rounded-xl h-fit">
                        <h2 class="text-xl font-semibold mb-4 text-white">Registrar Nova Produção</h2>
                        <form id="form-producao">
                            <label class="block text-sm mb-1">Selecione o Produto</label>
                            <select id="select-produto-producao" class="w-full p-2 border rounded-md mb-4" required></select>
                            <label class="block text-sm mb-1">Quantidade a Produzir</label>
                            <input type="number" id="qtd-produzida" placeholder="Qtd." class="w-full p-2 border rounded-md mb-4" required>
                            <button type="submit" class="w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Registrar Produção</button>
                        </form>
                        <div class="mt-6">
                            <h3 class="font-semibold mb-2 text-white">Análise de Insumos para Produção</h3>
                            <div id="producao-necessidades" class="space-y-2 max-h-48 overflow-y-auto p-2 border border-[#334155] rounded-md bg-[#1e293b]">
                                <p class="text-slate-400 text-sm">Selecione um produto e a quantidade.</p>
                            </div>
                        </div>
                    </div>
                     <div class="lg:col-span-2 bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="text-xl font-semibold text-white">Histórico de Produção</h2>
                             <button id="exportar-relatorio-producao" class="bg-blue-600 text-white p-2 rounded-md font-semibold text-sm hover:bg-blue-700 transition-all">Exportar Relatório</button>
                        </div>
                        <div class="max-h-[60vh] overflow-y-auto">
                            <table class="w-full text-left">
                                <thead class="border-b border-[#334155]">
                                    <tr>
                                        <th class="p-2">Data</th>
                                        <th class="p-2">Produto</th>
                                        <th class="p-2">Qtd.</th>
                                        <th class="p-2">Custo Total</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-producao"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Estoque -->
            <section id="estoque" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white">Dashboard de Estoque</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-white">Top 5 - Maior Estoque</h2>
                        <div id="estoque-alto" class="space-y-3"></div>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-white">Top 5 - Menor Estoque</h2>
                        <div id="estoque-baixo" class="space-y-3"></div>
                    </div>
                </div>
            </section>

            <!-- Perfil -->
            <section id="perfil" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white">Perfil do Usuário</h1>
                <div class="max-w-2xl mx-auto bg-[#0f172a] border border-[#334155] p-8 rounded-xl">
                     <form id="form-perfil">
                        <div class="text-center mb-8">
                             <img id="perfil-imagem-preview" src="https://placehold.co/128x128/0f172a/e2e8f0?text=Logo" class="w-32 h-32 object-cover rounded-full bg-[#1e293b] mx-auto border-2 border-[#334155]">
                             <input type="file" id="perfil-imagem" class="hidden" accept="image/*">
                             <label for="perfil-imagem" class="cursor-pointer text-sm text-blue-400 mt-2 block">Alterar logo</label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Nome da Empresa</label>
                                <input type="text" id="perfil-empresa-nome" class="w-full p-2 border rounded-md">
                            </div>
                             <div>
                                <label class="block text-sm font-medium mb-1">E-mail de Contato</label>
                                <input type="email" id="perfil-email" class="w-full p-2 border rounded-md">
                            </div>
                        </div>
                         <div class="mt-4">
                            <label class="block text-sm font-medium mb-1">Informações Adicionais</label>
                            <textarea id="perfil-info" class="w-full p-2 border rounded-md h-24"></textarea>
                        </div>
                         <button type="submit" class="mt-6 w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Salvar Perfil</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para confirmação -->
    <div id="modal-confirmacao" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-[#0f172a] border border-[#334155] p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h2 id="modal-titulo" class="text-xl font-bold mb-4 text-white"></h2>
            <p id="modal-mensagem" class="text-slate-300"></p>
            <div class="mt-6 flex justify-end gap-4">
                <button id="modal-btn-cancelar" class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-500">Cancelar</button>
                <button id="modal-btn-confirmar" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Calculadora -->
    <div id="modal-calculadora" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-[#0f172a] border border-[#334155] p-8 rounded-lg shadow-xl max-w-md w-full">
            <h2 class="text-xl font-bold mb-6 text-white">Calculadora de Custo de Insumo</h2>
            <div class="space-y-4">
                <div>
                    <label class="text-sm">Custo Total do Insumo (ex: galão de cola)</label>
                    <input type="number" step="0.01" id="calc-custo-total" placeholder="R$ 74,00" class="w-full p-2 border rounded-md mt-1">
                </div>
                <div>
                    <label class="text-sm">Quantidade Total do Insumo (ex: 2.3 kg)</label>
                    <input type="number" step="0.001" id="calc-qtd-total" placeholder="2.3" class="w-full p-2 border rounded-md mt-1">
                </div>
                <div>
                    <label class="text-sm">Rendimento Total (quantos itens você faz)</label>
                    <input type="number" id="calc-rendimento" placeholder="100" class="w-full p-2 border rounded-md mt-1">
                </div>
            </div>
            <div class="mt-6 p-4 bg-[#1e293b] rounded-md border border-[#334155] space-y-2">
                <h3 class="font-semibold text-white">Resultados por Unidade Produzida:</h3>
                <p class="text-sm">Custo por unidade: <span id="calc-resultado-custo-un" class="font-bold text-green-400">R$ 0,00</span></p>
                <p class="text-sm">Qtd. de insumo por unidade: <span id="calc-resultado-qtd-un" class="font-bold text-blue-400">0</span></p>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="modal-calculadora-fechar" class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-500">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>


    <!-- JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- ESTADO DA APLICAÇÃO ---
        let state = {
            perfil: {
                nomeEmpresa: 'Vexx',
                email: 'contato@vexx.com',
                info: '',
                imagem: 'https://placehold.co/128x128/0f172a/e2e8f0?text=V'
            },
            despesas: {
                fixos: [],
                variaveis: [],
                percentuais: []
            },
            insumos: [], 
            produtos: [],
            producao: [] 
        };

        // --- SELETORES DO DOM ---
        const navLinks = document.querySelectorAll('.nav-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const mobileMenuButton = document.getElementById('mobileMenuButton');
        const sidebar = document.querySelector('aside');
        
        // --- FUNÇÕES DE PERSISTÊNCIA ---
        const saveState = () => localStorage.setItem('vexxGestorState', JSON.stringify(state));
        const loadState = () => {
            const savedState = localStorage.getItem('vexxGestorState');
            if (savedState) {
                state = JSON.parse(savedState);
                state.perfil = state.perfil || { nomeEmpresa: 'Vexx', email: 'contato@vexx.com', info: '', imagem: 'https://placehold.co/128x128/0f172a/e2e8f0?text=V' };
                state.despesas = state.despesas || { fixos: [], variaveis: [], percentuais: [] };
                state.insumos = state.insumos || [];
                state.produtos = state.produtos || [];
                state.producao = state.producao || [];
            }
        };

        // --- FUNÇÕES DE UI ---
        const toastContainer = document.getElementById('toast-container');
        const showToast = (message, type = 'success', duration = 3000) => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        };

        const switchTab = (hash) => {
            hash = hash || '#dashboard';
            navLinks.forEach(link => link.classList.toggle('active', link.getAttribute('href') === hash));
            tabContents.forEach(content => {
                const isActive = `#${content.id}` === hash;
                content.classList.toggle('active', isActive);
                content.classList.toggle('fade-in', isActive);
            });
            if (window.innerWidth < 768) sidebar.classList.add('hidden');
        };

        mobileMenuButton.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('flex');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('z-20');
            sidebar.classList.toggle('h-full');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = e.currentTarget.getAttribute('href');
            });
        });
        
        window.addEventListener('hashchange', () => switchTab(window.location.hash));

        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

        const showModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
        const hideModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
        
        const showConfirmationModal = (title, message, onConfirm) => {
            const modal = document.getElementById('modal-confirmacao');
            modal.querySelector('#modal-titulo').textContent = title;
            modal.querySelector('#modal-mensagem').textContent = message;
            showModal('modal-confirmacao');
            const confirmBtn = modal.querySelector('#modal-btn-confirmar');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.onclick = () => { onConfirm(); hideModal('modal-confirmacao'); };
            modal.querySelector('#modal-btn-cancelar').onclick = () => hideModal('modal-confirmacao');
        };

        // --- LÓGICA GERAL ---
        const saveAndRerender = () => {
            saveState();
            renderAll();
        };

        const renderAll = () => {
            renderDashboard();
            renderDespesas();
            renderInsumos();
            renderProdutos();
            renderProducao();
            renderEstoque();
            renderPerfil();
        };

        // --- LÓGICA DAS ABAS ---

        const renderDashboard = () => {
             document.getElementById('dashboard-custo-total').textContent = formatCurrency(calculateAndRenderCustoTotalMensal());
             const inicioMes = new Date();
             inicioMes.setDate(1);
             inicioMes.setHours(0,0,0,0);
             const producaoMes = state.producao.filter(p => new Date(p.data) >= inicioMes);
             document.getElementById('dashboard-producao-mes').textContent = `${producaoMes.reduce((acc, p) => acc + p.quantidade, 0)} unidades`;
             const receitaEstimada = producaoMes.reduce((acc, reg) => {
                const produto = state.produtos.find(p => p.id === reg.produtoId);
                if (produto) {
                    const precoVenda = getCustoProduto(produto.id) * (1 + produto.margemLucro / 100);
                    return acc + (precoVenda * reg.quantidade);
                }
                return acc;
             }, 0);
             document.getElementById('dashboard-receita-estimada').textContent = formatCurrency(receitaEstimada);
             const custoProducaoMes = producaoMes.reduce((acc, reg) => acc + reg.custoTotal, 0);
             document.getElementById('dashboard-lucro-estimado').textContent = formatCurrency(receitaEstimada - custoProducaoMes);
            const alertasContainer = document.getElementById('dashboard-alertas-estoque');
            alertasContainer.innerHTML = '';
            const insumosBaixoEstoque = state.insumos.filter(i => i.estoque <= 10);
            if (insumosBaixoEstoque.length > 0) {
                insumosBaixoEstoque.forEach(i => {
                    const p = document.createElement('p');
                    p.className = 'text-sm text-yellow-200 bg-yellow-900/50 border border-yellow-500/30 p-2 rounded-md';
                    p.textContent = `${i.nome}: Apenas ${i.estoque} ${i.unidade} em estoque.`;
                    alertasContainer.appendChild(p);
                });
            } else {
                alertasContainer.innerHTML = '<p class="text-slate-400">Nenhum alerta no momento.</p>';
            }
            const maisProduzidosContainer = document.getElementById('dashboard-mais-produzidos');
            maisProduzidosContainer.innerHTML = '';
            if (state.producao.length > 0) {
                const contagem = state.producao.reduce((acc, reg) => {
                    acc[reg.produtoId] = (acc[reg.produtoId] || 0) + reg.quantidade;
                    return acc;
                }, {});
                const sorted = Object.entries(contagem).sort(([,a],[,b]) => b-a).slice(0, 5);
                if (sorted.length === 0) {
                     maisProduzidosContainer.innerHTML = '<p class="text-slate-400">Nenhum produto produzido ainda.</p>';
                } else {
                    sorted.forEach(([produtoId, qtd]) => {
                         const produto = state.produtos.find(p => p.id === produtoId);
                         if(produto) {
                            const div = document.createElement('div');
                            div.className = 'flex justify-between text-sm';
                            div.innerHTML = `<span>${produto.nome}</span><span class="font-semibold">${qtd} un.</span>`;
                            maisProduzidosContainer.appendChild(div);
                         }
                    });
                }
            } else {
                maisProduzidosContainer.innerHTML = '<p class="text-slate-400">Nenhum produto registrado.</p>';
            }
        };

        const renderDespesas = () => {
            const listas = { fixos: document.getElementById('lista-custos-fixos'), variaveis: document.getElementById('lista-custos-variaveis'), percentuais: document.getElementById('lista-custos-percentuais') };
            Object.values(listas).forEach(lista => lista.innerHTML = '');
            ['fixos', 'variaveis', 'percentuais'].forEach(tipo => {
                if (state.despesas[tipo].length === 0) {
                     listas[tipo].innerHTML = `<p class="text-sm text-slate-400">Nenhuma despesa adicionada.</p>`
                } else {
                    state.despesas[tipo].forEach(despesa => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center bg-[#1e293b] p-2 rounded-md border border-[#334155]';
                        const isPercentual = tipo === 'percentuais';
                        div.innerHTML = `<span>${despesa.nome}</span>
                            <div class="flex items-center gap-3"><span class="font-semibold">${isPercentual ? `${despesa.valor}%` : formatCurrency(despesa.valor)}</span>
                            <button data-id="${despesa.id}" data-tipo="${tipo}" class="text-red-400 hover:text-red-300 font-bold text-lg">&times;</button></div>`;
                        listas[tipo].appendChild(div);
                    });
                }
            });
            document.querySelectorAll('#despesas button[data-id]').forEach(btn => {
                btn.onclick = (e) => {
                    const { id, tipo } = e.currentTarget.dataset;
                    showConfirmationModal('Excluir Despesa', 'Tem certeza?', () => {
                        state.despesas[tipo] = state.despesas[tipo].filter(d => d.id !== id);
                        saveAndRerender(); showToast('Despesa excluída!', 'info');
                    });
                };
            });
            calculateAndRenderCustoTotalMensal();
        };

        const calculateAndRenderCustoTotalMensal = () => {
            const total = state.despesas.fixos.reduce((a, d) => a + parseFloat(d.valor), 0) + state.despesas.variaveis.reduce((a, d) => a + parseFloat(d.valor), 0);
            document.getElementById('custo-total-mensal').textContent = formatCurrency(total);
            return total;
        };

        const renderInsumos = () => {
            const lista = document.getElementById('lista-insumos');
            lista.innerHTML = state.insumos.length === 0 ? `<tr><td colspan="4" class="p-4 text-center text-slate-400">Nenhum insumo cadastrado.</td></tr>` : '';
            state.insumos.forEach(insumo => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-[#334155]';
                tr.innerHTML = `<td class="p-2">${insumo.nome}</td>
                    <td class="p-2">${formatCurrency(insumo.preco / insumo.estoque)} / ${insumo.unidade}</td>
                    <td class="p-2">${insumo.estoque} ${insumo.unidade}</td>
                    <td class="p-2 flex gap-2"><button data-edit-id="${insumo.id}" class="text-blue-400 hover:text-blue-300">Editar</button>
                    <button data-delete-id="${insumo.id}" class="text-red-400 hover:text-red-300">Excluir</button></td>`;
                lista.appendChild(tr);
            });
            document.querySelectorAll('#insumos [data-delete-id]').forEach(btn => {
                btn.onclick = e => showConfirmationModal('Excluir Insumo', 'Tem certeza? Isso pode afetar produtos.', () => {
                    const id = e.currentTarget.dataset.deleteId;
                    state.insumos = state.insumos.filter(i => i.id !== id);
                    state.produtos.forEach(p => p.insumos = p.insumos.filter(i => i.insumoId !== id));
                    saveAndRerender(); showToast('Insumo excluído.', 'info');
                });
            });
            document.querySelectorAll('#insumos [data-edit-id]').forEach(btn => {
                btn.onclick = e => {
                    const insumo = state.insumos.find(i => i.id === e.currentTarget.dataset.editId);
                    if (insumo) {
                        document.getElementById('insumo-id').value = insumo.id;
                        document.getElementById('insumo-nome').value = insumo.nome;
                        document.getElementById('insumo-desc').value = insumo.desc;
                        document.getElementById('insumo-preco').value = insumo.preco;
                        document.getElementById('insumo-estoque').value = insumo.estoque;
                        document.getElementById('insumo-unidade').value = insumo.unidade;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                };
            });
            populateInsumoSelects();
        };

        const renderProdutos = () => {
            const listaProdutos = document.getElementById('lista-produtos');
            listaProdutos.innerHTML = state.produtos.length === 0 ? `<p class="text-slate-400 md:col-span-2 text-center">Nenhum produto cadastrado.</p>` : '';
            state.produtos.forEach(produto => {
                const custo = getCustoProduto(produto.id);
                const precoVenda = custo * (1 + produto.margemLucro / 100);
                const card = document.createElement('div');
                card.className = "bg-[#0f172a] border border-[#334155] rounded-xl overflow-hidden flex flex-col";
                card.innerHTML = `<img src="${produto.imagem}" alt="[Imagem de ${produto.nome}]" class="w-full h-40 object-cover">
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="font-bold text-lg text-white">${produto.nome}</h3>
                        <p class="text-slate-400 text-sm mb-4 flex-grow">${produto.desc}</p>
                        <div class="text-xs space-y-1 mt-2">
                             <div class="flex justify-between"><span>Custo Unidade:</span> <span class="font-semibold">${formatCurrency(custo)}</span></div>
                             <div class="flex justify-between"><span>Preço Venda:</span> <span class="font-semibold text-green-400">${formatCurrency(precoVenda)}</span></div>
                        </div>
                         <div class="mt-4 flex gap-2">
                            <button data-edit-id="${produto.id}" class="w-full text-sm bg-blue-600 text-white p-2 rounded-md font-semibold hover:bg-blue-700">Editar</button>
                            <button data-delete-id="${produto.id}" class="w-full text-sm bg-red-600 text-white p-2 rounded-md font-semibold hover:bg-red-700">Excluir</button>
                        </div></div>`;
                listaProdutos.appendChild(card);
            });
            document.querySelectorAll('#produtos [data-delete-id]').forEach(btn => {
                btn.onclick = e => showConfirmationModal('Excluir Produto', 'Tem certeza?', () => {
                    state.produtos = state.produtos.filter(p => p.id !== e.currentTarget.dataset.deleteId);
                    saveAndRerender(); showToast('Produto excluído!', 'info');
                });
            });
            document.querySelectorAll('#produtos [data-edit-id]').forEach(btn => {
                btn.onclick = e => {
                    const produto = state.produtos.find(p => p.id === e.currentTarget.dataset.editId);
                    if(produto) {
                        document.getElementById('produto-id').value = produto.id;
                        document.getElementById('produto-nome').value = produto.nome;
                        document.getElementById('produto-desc').value = produto.desc;
                        document.getElementById('produto-imagem-preview').src = produto.imagem;
                        document.getElementById('produto-margem-lucro').value = produto.margemLucro;
                        currentProdutoInsumos = JSON.parse(JSON.stringify(produto.insumos));
                        renderProdutoInsumosList();
                        calculateProdutoCusto();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                };
            });
            populateProdutoSelects();
        };

        const renderProducao = () => {
             const lista = document.getElementById('lista-producao');
             lista.innerHTML = state.producao.length === 0 ? `<tr><td colspan="4" class="p-4 text-center text-slate-400">Nenhum registro de produção.</td></tr>` : '';
             [...state.producao].sort((a,b) => new Date(b.data) - new Date(a.data)).forEach(reg => {
                const produto = state.produtos.find(p => p.id === reg.produtoId);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-[#334155]';
                tr.innerHTML = `<td class="p-2">${new Date(reg.data).toLocaleDateString('pt-BR')}</td>
                    <td class="p-2">${produto ? produto.nome : 'Produto não encontrado'}</td>
                    <td class="p-2">${reg.quantidade}</td><td class="p-2">${formatCurrency(reg.custoTotal)}</td>`;
                lista.appendChild(tr);
             });
        };

        const renderEstoque = () => {
            const estoqueAltoContainer = document.getElementById('estoque-alto');
            const estoqueBaixoContainer = document.getElementById('estoque-baixo');
            estoqueAltoContainer.innerHTML = '';
            estoqueBaixoContainer.innerHTML = '';

            if (state.insumos.length === 0) {
                estoqueAltoContainer.innerHTML = `<p class="text-slate-400 text-sm">Nenhum insumo cadastrado.</p>`;
                estoqueBaixoContainer.innerHTML = `<p class="text-slate-400 text-sm">Nenhum insumo cadastrado.</p>`;
                return;
            }

            const sortedByStock = [...state.insumos].sort((a, b) => b.estoque - a.estoque);
            const top5 = sortedByStock.slice(0, 5);
            const bottom5 = sortedByStock.slice(-5).reverse();

            top5.forEach(insumo => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-[#1e293b] p-2 rounded-md';
                div.innerHTML = `<span>${insumo.nome}</span><span class="font-semibold text-green-400">${insumo.estoque} ${insumo.unidade}</span>`;
                estoqueAltoContainer.appendChild(div);
            });
            bottom5.forEach(insumo => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-[#1e293b] p-2 rounded-md';
                div.innerHTML = `<span>${insumo.nome}</span><span class="font-semibold text-yellow-400">${insumo.estoque} ${insumo.unidade}</span>`;
                estoqueBaixoContainer.appendChild(div);
            });
        };

        const renderPerfil = () => {
             document.getElementById('perfil-empresa-nome').value = state.perfil.nomeEmpresa;
             document.getElementById('perfil-email').value = state.perfil.email;
             document.getElementById('perfil-info').value = state.perfil.info;
             document.getElementById('perfil-imagem-preview').src = state.perfil.imagem;
        };

        const getCustoProduto = (produtoId) => {
            const produto = state.produtos.find(p => p.id === produtoId);
            if(!produto) return 0;
            return produto.insumos.reduce((total, item) => {
                const insumoData = state.insumos.find(i => i.id === item.insumoId);
                const precoPorUnidadeBase = insumoData ? (insumoData.preco / insumoData.estoque) : 0;
                return total + (precoPorUnidadeBase * item.quantidade);
            }, 0);
        };
        
        let currentProdutoInsumos = []; 
        const calculateProdutoCusto = () => {
            const custoTotalInsumos = currentProdutoInsumos.reduce((acc, item) => {
                const insumo = state.insumos.find(i => i.id === item.insumoId);
                // Custo é proporcional à quantidade do insumo usado no produto
                const precoUnitarioInsumo = insumo ? insumo.preco / insumo.estoque : 0;
                return acc + (precoUnitarioInsumo * item.quantidade);
            }, 0);
            document.getElementById('produto-custo-calculado').textContent = formatCurrency(custoTotalInsumos);
            const margemLucro = parseFloat(document.getElementById('produto-margem-lucro').value) || 0;
            const precoSugerido = custoTotalInsumos * (1 + margemLucro / 100);
            document.getElementById('produto-preco-sugerido').textContent = formatCurrency(precoSugerido);
        };
        
        const renderProdutoInsumosList = () => {
            const container = document.getElementById('produto-insumos-lista');
            container.innerHTML = (currentProdutoInsumos.length === 0) ? '<p class="text-slate-400 text-sm">Nenhum insumo adicionado.</p>' : '';
            currentProdutoInsumos.forEach(item => {
                const insumoData = state.insumos.find(i => i.id === item.insumoId);
                if (insumoData) {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm bg-slate-900 p-1.5 rounded';
                    div.innerHTML = `<span>${insumoData.nome} (${item.quantidade} ${insumoData.unidade})</span>
                        <button type="button" data-id="${item.insumoId}" class="text-red-400 font-bold px-2">&times;</button>`;
                    container.appendChild(div);
                }
            });
            container.querySelectorAll('button').forEach(btn => {
                btn.onclick = e => {
                    currentProdutoInsumos = currentProdutoInsumos.filter(i => i.insumoId !== e.currentTarget.dataset.id);
                    renderProdutoInsumosList(); calculateProdutoCusto();
                };
            });
        };

        const updateProducaoNecessidades = () => {
            const container = document.getElementById('producao-necessidades');
            const produtoId = document.getElementById('select-produto-producao').value;
            const quantidade = parseFloat(document.getElementById('qtd-produzida').value);
            container.innerHTML = '';

            if (!produtoId || !quantidade || quantidade <= 0) {
                container.innerHTML = '<p class="text-slate-400 text-sm">Selecione um produto e a quantidade.</p>';
                return;
            }

            const produto = state.produtos.find(p => p.id === produtoId);
            if (!produto) return;

            if (produto.insumos.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-sm">Este produto não possui insumos cadastrados.</p>';
                return;
            }

            produto.insumos.forEach(item => {
                const insumoData = state.insumos.find(i => i.id === item.insumoId);
                if (insumoData) {
                    const necessario = item.quantidade * quantidade;
                    const disponivel = insumoData.estoque;
                    const statusOk = disponivel >= necessario;
                    const div = document.createElement('div');
                    div.className = `p-2 rounded-md text-sm ${statusOk ? 'bg-green-900/50' : 'bg-red-900/50'}`;
                    div.innerHTML = `<div class="font-bold">${insumoData.nome}</div>
                        <div>Necessário: ${necessario.toFixed(3)} ${insumoData.unidade}</div>
                        <div>Disponível: ${disponivel.toFixed(3)} ${insumoData.unidade}</div>
                        <div class="font-bold mt-1 ${statusOk ? 'text-green-400' : 'text-red-400'}">
                            ${statusOk ? 'ESTOQUE OK' : `FALTAM ${(necessario - disponivel).toFixed(3)} ${insumoData.unidade}`}
                        </div>`;
                    container.appendChild(div);
                }
            });
        };
        
        // --- EVENT LISTENERS ---
        ['fixo', 'variavel', 'percentual'].forEach(type => {
            document.getElementById(`form-custo-${type}`).addEventListener('submit', (e) => {
                e.preventDefault();
                const nome = document.getElementById(`${type}-nome`).value;
                const valor = parseFloat(document.getElementById(`${type}-valor`).value);
                const targetArray = type === 'percentual' ? state.despesas.percentuais : (type === 'fixo' ? state.despesas.fixos : state.despesas.variaveis);
                if (nome && valor > 0) {
                    targetArray.push({ id: generateId(), nome, valor });
                    e.target.reset(); saveAndRerender(); showToast('Despesa adicionada!', 'success');
                }
            });
        });

        document.getElementById('form-insumo').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('insumo-id').value;
            const insumoData = {
                nome: document.getElementById('insumo-nome').value, desc: document.getElementById('insumo-desc').value,
                preco: parseFloat(document.getElementById('insumo-preco').value), estoque: parseFloat(document.getElementById('insumo-estoque').value),
                unidade: document.getElementById('insumo-unidade').value,
            };
            if (id) {
                const index = state.insumos.findIndex(i => i.id === id);
                state.insumos[index] = { ...state.insumos[index], ...insumoData };
                showToast('Insumo atualizado!', 'success');
            } else {
                state.insumos.push({ id: generateId(), ...insumoData });
                showToast('Insumo adicionado!', 'success');
            }
            e.target.reset();
            document.getElementById('insumo-id').value = '';
            saveAndRerender();
        });

        document.getElementById('form-produto').addEventListener('submit', (e) => {
            e.preventDefault();
            const produtoId = document.getElementById('produto-id').value;
            const produtoData = {
                nome: document.getElementById('produto-nome').value, desc: document.getElementById('produto-desc').value,
                imagem: document.getElementById('produto-imagem-preview').src, insumos: currentProdutoInsumos,
                margemLucro: parseFloat(document.getElementById('produto-margem-lucro').value)
            };
            if (produtoId) {
                const index = state.produtos.findIndex(p => p.id === produtoId);
                state.produtos[index] = { ...state.produtos[index], ...produtoData };
                showToast('Produto atualizado!', 'success');
            } else {
                state.produtos.push({ id: generateId(), ...produtoData });
                showToast('Produto adicionado!', 'success');
            }
            e.target.reset();
            document.getElementById('produto-id').value = '';
            document.getElementById('produto-imagem-preview').src = 'https://placehold.co/600x400/0f172a/e2e8f0?text=Foto+do+Produto';
            currentProdutoInsumos = []; saveAndRerender();
        });
        
        document.getElementById('btn-add-insumo-produto').addEventListener('click', () => {
            const insumoId = document.getElementById('select-insumo-para-produto').value;
            const quantidade = parseFloat(document.getElementById('qtd-insumo-para-produto').value);
            if (insumoId && quantidade > 0 && !currentProdutoInsumos.some(i => i.insumoId === insumoId)) {
                currentProdutoInsumos.push({ insumoId, quantidade });
                renderProdutoInsumosList(); calculateProdutoCusto();
                document.getElementById('qtd-insumo-para-produto').value = '';
            }
        });
        
        document.getElementById('produto-margem-lucro').addEventListener('input', calculateProdutoCusto);

        document.getElementById('form-producao').addEventListener('submit', (e) => {
            e.preventDefault();
            const produtoId = document.getElementById('select-produto-producao').value;
            const quantidade = parseFloat(document.getElementById('qtd-produzida').value);
            const produto = state.produtos.find(p => p.id === produtoId);
            if(!produto || !quantidade || quantidade <= 0) { showToast('Dados de produção inválidos.', 'error'); return; }
            const insumosFaltando = produto.insumos.map(item => ({...state.insumos.find(i => i.id === item.insumoId), necessario: item.quantidade * quantidade })).filter(insumo => !insumo.id || insumo.estoque < insumo.necessario);
            if (insumosFaltando.length > 0) { showToast(`Estoque insuficiente para: ${insumosFaltando.map(i => i.nome).join(', ')}`, 'error'); return; }
            produto.insumos.forEach(item => { state.insumos.find(i => i.id === item.insumoId).estoque -= item.quantidade * quantidade; });
            state.producao.push({ id: generateId(), produtoId: produtoId, quantidade: quantidade, data: new Date().toISOString(), custoTotal: getCustoProduto(produtoId) * quantidade });
            e.target.reset(); saveAndRerender(); showToast('Produção registrada!', 'success');
        });
        
        document.getElementById('select-produto-producao').addEventListener('input', updateProducaoNecessidades);
        document.getElementById('qtd-produzida').addEventListener('input', updateProducaoNecessidades);

        document.getElementById('form-perfil').addEventListener('submit', (e) => {
            e.preventDefault();
            state.perfil.nomeEmpresa = document.getElementById('perfil-empresa-nome').value;
            state.perfil.email = document.getElementById('perfil-email').value;
            state.perfil.info = document.getElementById('perfil-info').value;
            state.perfil.imagem = document.getElementById('perfil-imagem-preview').src;
            saveAndRerender(); showToast('Perfil salvo!', 'success');
        });

        // Calculadora Logic
        document.getElementById('btn-abrir-calculadora').addEventListener('click', () => showModal('modal-calculadora'));
        document.getElementById('modal-calculadora-fechar').addEventListener('click', () => hideModal('modal-calculadora'));
        const calcInputs = ['calc-custo-total', 'calc-qtd-total', 'calc-rendimento'];
        calcInputs.forEach(id => document.getElementById(id).addEventListener('input', () => {
            const custo = parseFloat(document.getElementById('calc-custo-total').value) || 0;
            const qtd = parseFloat(document.getElementById('calc-qtd-total').value) || 0;
            const rendimento = parseFloat(document.getElementById('calc-rendimento').value) || 0;
            if (rendimento > 0) {
                document.getElementById('calc-resultado-custo-un').textContent = formatCurrency(custo / rendimento);
                document.getElementById('calc-resultado-qtd-un').textContent = `${(qtd / rendimento).toFixed(4)}`;
            }
        }));
        
        const populateInsumoSelects = () => {
            const select = document.getElementById('select-insumo-para-produto');
            select.innerHTML = '<option value="">Selecione um insumo...</option>';
            state.insumos.forEach(insumo => select.innerHTML += `<option value="${insumo.id}">${insumo.nome} (${insumo.unidade})</option>`);
        };
        const populateProdutoSelects = () => {
             const select = document.getElementById('select-produto-producao');
             select.innerHTML = '<option value="">Selecione um produto...</option>';
             state.produtos.forEach(produto => select.innerHTML += `<option value="${produto.id}">${produto.nome}</option>`);
        };
        const handleImageUpload = (inputId, previewId) => {
             document.getElementById(inputId).onchange = e => {
                 const file = e.target.files[0];
                 if (file) { const reader = new FileReader(); reader.onload = ev => document.getElementById(previewId).src = ev.target.result; reader.readAsDataURL(file); }
             };
        };
        handleImageUpload('produto-imagem', 'produto-imagem-preview');
        handleImageUpload('perfil-imagem', 'perfil-imagem-preview');
        
        // --- INICIALIZAÇÃO ---
        loadState();
        switchTab(window.location.hash || '#dashboard');
        renderAll();

    });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vexx - App de Gestão de Produção</title>
    
    <!-- Tailwind CSS para um design moderno e responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Estilos CSS customizados para o tema Dark Blue (Light) -->
    <style>
        /* Define a fonte Inter e o tema escuro como padrão */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1e293b; /* Fundo azul-ardósia principal */
            color: #e2e8f0; /* Cor de texto padrão (cinza claro) */
            padding-bottom: 80px; /* Espaço para a barra de navegação inferior no mobile */
        }
        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }
        }

        /* Classes para transições suaves */
        .transition-all {
            transition: all 0.3s ease-in-out;
        }
        
        /* Estilo para a aba ativa na navegação */
        .nav-link.active {
            background-color: #3b82f6; /* Azul destacado */
            color: #ffffff;
            font-weight: 600;
        }

        .nav-link:hover {
            background-color: #334155; /* Fundo mais escuro no hover */
        }
        
        /* Oculta as abas de conteúdo por padrão */
        .tab-content {
            display: none;
        }

        /* Mostra a aba ativa */
        .tab-content.active {
            display: block;
        }
        
        /* Animação de entrada */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }

        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Estilização de Inputs para o tema dark */
        input, textarea, select {
            background-color: #0f172a;
            border-color: #475569;
            color: #e2e8f0;
            font-size: 1rem; /* Garante tamanho legível no mobile */
        }
        input::placeholder, textarea::placeholder {
            color: #94a3b8;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #1e293b, 0 0 0 4px #3b82f6;
        }

        /* Estilo para o Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #475569;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type=range]:hover {
            opacity: 1;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Estilo Toast (Notificações) */
        #toast-container {
            position: fixed;
            bottom: 80px; /* Acima da barra de navegação no mobile */
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        @media (min-width: 768px) {
            #toast-container {
                bottom: 20px;
            }
        }
        .toast {
            padding: 16px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: scale(0.9);
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show {
            opacity: 1;
            transform: scale(1);
        }
        .toast.success { background-color: #22c55e; } /* Verde */
        .toast.error { background-color: #ef4444; } /* Vermelho */
        .toast.info { background-color: #3b82f6; } /* Azul */
        
        /* Tabela Responsiva para Card List no Mobile */
        @media (max-width: 767px) {
            .responsive-table thead {
                display: none;
            }
            .responsive-table tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #334155;
                border-radius: 0.5rem;
                overflow: hidden;
            }
            .responsive-table td {
                display: block;
                text-align: right;
                padding-left: 50%;
                position: relative;
                border-bottom: 1px solid #334155;
            }
            .responsive-table td:last-child {
                border-bottom: 0;
            }
            .responsive-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 0.5rem;
                width: 45%;
                padding-right: 0.5rem;
                text-align: left;
                font-weight: 600;
                color: #94a3b8;
            }
        }
    </style>
</head>
<body class="text-gray-200">

    <!-- Estrutura principal com Sidebar (Desktop) e Conteúdo -->
    <div class="flex h-screen bg-[#1e293b]">
        
        <!-- Sidebar (Navegação Desktop) -->
        <aside class="w-64 bg-[#0f172a] border-r border-[#334155] flex-shrink-0 hidden md:flex md:flex-col">
            <div class="p-6 text-3xl font-bold text-white border-b border-[#334155]">
                Vexx
            </div>
            <nav class="flex-grow p-4 space-y-2">
                <a href="#dashboard" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                    Dashboard
                </a>
                <a href="#custos" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"></path>
                    </svg>
                    Custos
                </a>
                <a href="#insumos" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                    Insumos
                </a>
                <a href="#produtos" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                    Produtos
                </a>
                <a href="#producao" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Produção
                </a>
                <a href="#estoque" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" /></svg>
                    Estoque
                </a>
            </nav>
            <div class="p-4 border-t border-[#334155]">
                 <a href="#perfil" class="nav-link flex items-center px-4 py-2.5 rounded-lg transition-all">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    Perfil
                </a>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">

            <!-- Header Mobile -->
            <div class="md:hidden flex justify-between items-center mb-6">
                 <h1 class="text-2xl font-bold text-white">Vexx</h1>
                 <a href="#perfil" class="p-2 rounded-full bg-slate-700">
                     <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                 </a>
            </div>
            
            <!-- ABAS DE CONTEÚDO -->

            <!-- Dashboard -->
            <section id="dashboard" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white hidden md:block">Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-sm font-medium text-slate-400">Custo Mensal Total</h3>
                        <p id="dashboard-custo-total" class="text-3xl font-bold mt-2 text-white">R$ 0,00</p>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-sm font-medium text-slate-400">Produção do Mês</h3>
                        <p id="dashboard-producao-mes" class="text-3xl font-bold mt-2 text-white">0 unidades</p>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-sm font-medium text-slate-400">Receita Estimada</h3>
                        <p id="dashboard-receita-estimada" class="text-3xl font-bold mt-2 text-white">R$ 0,00</p>
                    </div>
                     <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-sm font-medium text-slate-400">Lucro Estimado</h3>
                        <p id="dashboard-lucro-estimado" class="text-3xl font-bold mt-2 text-green-400">R$ 0,00</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="font-semibold text-lg mb-4 flex items-center text-white">
                            <svg class="w-5 h-5 mr-2 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                            Alertas de Estoque Baixo
                        </h3>
                        <div id="dashboard-alertas-estoque" class="space-y-2 max-h-48 overflow-y-auto"></div>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                         <h3 class="font-semibold text-lg mb-4 text-white">Produtos Mais Produzidos</h3>
                         <div id="dashboard-mais-produzidos" class="space-y-2"></div>
                    </div>
                </div>
            </section>

            <!-- Custos -->
            <section id="custos" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white hidden md:block">Gestão de Custos</h1>
                
                <h2 class="text-2xl font-semibold mb-4 text-white">Custos Operacionais Mensais</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-white">Custos Fixos</h3>
                        <form id="form-custo-fixo">
                            <input type="text" id="fixo-nome" placeholder="Ex: Aluguel" class="w-full p-2 border rounded-md mb-2" required>
                            <input type="number" id="fixo-valor" step="0.01" placeholder="Valor (R$)" class="w-full p-2 border rounded-md mb-4" required>
                            <button type="submit" class="w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Adicionar</button>
                        </form>
                        <div id="lista-custos-fixos" class="mt-6 space-y-2"></div>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-white">Outros Custos Mensais</h3>
                        <form id="form-custo-variavel">
                             <input type="text" id="variavel-nome" placeholder="Ex: Conta de Energia" class="w-full p-2 border rounded-md mb-2" required>
                            <input type="number" id="variavel-valor" step="0.01" placeholder="Valor (R$)" class="w-full p-2 border rounded-md mb-4" required>
                            <button type="submit" class="w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Adicionar</button>
                        </form>
                        <div id="lista-custos-variaveis" class="mt-6 space-y-2"></div>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h3 class="text-xl font-semibold mb-4 text-white">Projeção de Vendas</h3>
                        <form id="form-projecao">
                            <label class="block text-sm mb-1">Quantidade estimada de vendas no mês</label>
                            <input type="number" id="quantidade-estimada-vendas" placeholder="Ex: 500" class="w-full p-2 border rounded-md" required>
                        </form>
                    </div>
                </div>

                <h2 class="text-2xl font-semibold mt-10 mb-4 text-white">Custos por Unidade Produzida</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                         <h3 class="text-xl font-semibold mb-4 text-white">Custo de Mão de Obra</h3>
                         <form id="form-mao-de-obra" class="space-y-4">
                            <div>
                                <label class="text-sm">Salário Mensal (ou pró-labore)</label>
                                <input type="number" step="0.01" id="mao-salario" placeholder="R$ 3000,00" class="w-full p-2 border rounded-md mt-1">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm">Horas por dia</label>
                                    <input type="number" id="mao-horas-dia" placeholder="8" class="w-full p-2 border rounded-md mt-1">
                                </div>
                                 <div>
                                    <label class="text-sm">Dias por mês</label>
                                    <input type="number" id="mao-dias-mes" placeholder="22" class="w-full p-2 border rounded-md mt-1">
                                </div>
                            </div>
                            <div>
                                <label class="text-sm">Média de peças produzidas por HORA</label>
                                <input type="number" step="0.1" id="mao-pecas-hora" placeholder="2.5" class="w-full p-2 border rounded-md mt-1">
                            </div>
                         </form>
                    </div>
                     <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-white">Custos por Venda</h3>
                            <button type="button" id="custo-venda-calculadora" class="text-sm bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700">Calculadora</button>
                        </div>
                        <form id="form-custo-venda">
                             <input type="text" id="custo-venda-nome" placeholder="Ex: Caixa de Envio" class="w-full p-2 border rounded-md mb-2" required>
                             <input type="number" id="custo-venda-valor" step="0.01" placeholder="Custo Unitário (R$)" class="w-full p-2 border rounded-md mb-4" required>
                             <button type="submit" class="w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Adicionar Custo por Venda</button>
                        </form>
                         <div id="lista-custos-venda" class="mt-6 space-y-2"></div>
                    </div>
                </div>

                 <div class="mt-6 bg-[#0f172a] border border-[#334155] p-6 rounded-xl text-center">
                     <h2 class="text-xl font-bold text-white">Resumo de Custos Unitários para Precificação</h2>
                     <div class="mt-4 flex flex-wrap justify-center gap-x-8 gap-y-4">
                        <div>
                            <p class="text-slate-400 text-sm">Custo Fixo por Unidade</p>
                            <p id="resumo-custo-fixo" class="font-bold text-xl text-amber-400">R$ 0,00</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Custo Mão de Obra por Unidade</p>
                            <p id="resumo-mao-de-obra" class="font-bold text-xl text-amber-400">R$ 0,00</p>
                        </div>
                        <div>
                            <p class="text-slate-400 text-sm">Total de Custos por Venda</p>
                            <p id="resumo-custo-venda" class="font-bold text-xl text-amber-400">R$ 0,00</p>
                        </div>
                     </div>
                </div>
            </section>

            <!-- Insumos -->
            <section id="insumos" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white hidden md:block">Cadastro de Insumos</h1>
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                     <div class="md:hidden"></div> <!-- Spacer for mobile -->
                    <button id="btn-novo-insumo-mobile" class="w-full md:w-auto md:hidden bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-blue-700">Novo Insumo</button>
                    <div class="hidden md:block">
                        <input type="file" id="importar-insumos-nf" class="hidden">
                        <label for="importar-insumos-nf" class="cursor-pointer bg-green-600 text-white p-2.5 rounded-md font-semibold text-sm hover:bg-green-700 transition-all">Importar de NF</label>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div id="insumo-form-container" class="hidden lg:block lg:col-span-1 bg-[#0f172a] border border-[#334155] p-6 rounded-xl h-fit">
                        <h2 class="text-xl font-semibold mb-4 text-white">Novo Insumo</h2>
                        <form id="form-insumo">
                            <input type="hidden" id="insumo-id">
                            <label class="block mb-4 text-center cursor-pointer">
                                <img id="insumo-imagem-preview" src="https://placehold.co/600x400/0f172a/e2e8f0?text=Foto+do+Insumo" class="w-full h-40 object-cover rounded-md bg-[#020617]">
                                <input type="file" id="insumo-imagem" class="hidden" accept="image/*">
                                <span class="text-sm text-blue-400 mt-1 block">Clique para enviar uma foto</span>
                            </label>
                            <input type="text" id="insumo-nome" placeholder="Nome do insumo" class="w-full p-2 border rounded-md mb-2" required>
                            <textarea id="insumo-desc" placeholder="Descrição (opcional)" class="w-full p-2 border rounded-md mb-2 h-20"></textarea>
                            <input type="number" id="insumo-preco" step="0.01" placeholder="Preço Unitário (R$)" class="w-full p-2 border rounded-md mb-2" required>
                            <input type="number" id="insumo-estoque" step="0.001" placeholder="Qtd. em estoque" class="w-full p-2 border rounded-md mb-2" required>
                            <label class="block text-sm mb-1 mt-2">Unidade de Medida</label>
                            <select id="insumo-unidade" class="w-full p-2 border rounded-md mb-4" required>
                                <option value="un">Unidade (un)</option>
                                <option value="kg">Quilograma (kg)</option>
                                <option value="g">Grama (g)</option>
                                <option value="L">Litro (L)</option>
                                <option value="mL">Mililitro (mL)</option>
                                <option value="m">Metro (m)</option>
                                <option value="cm">Centímetro (cm)</option>
                            </select>
                            <button type="submit" class="w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Salvar Insumo</button>
                             <button id="btn-cancelar-insumo" type="button" class="md:hidden mt-2 w-full bg-slate-600 text-white p-2.5 rounded-md font-semibold hover:bg-slate-500">Cancelar</button>
                        </form>
                    </div>
                    <div id="insumo-list-container" class="lg:col-span-2 bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-white">Lista de Insumos</h2>
                        <div class="max-h-[60vh] overflow-y-auto">
                            <table class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-2 w-16">Foto</th>
                                        <th class="p-2">Nome</th>
                                        <th class="p-2">Preço Unit.</th>
                                        <th class="p-2">Estoque</th>
                                        <th class="p-2">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-insumos"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
             <!-- Produtos -->
            <section id="produtos" class="tab-content">
                <div id="produtos-lista-view">
                    <h1 class="text-3xl font-bold mb-6 text-white hidden md:block">Meus Produtos</h1>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                             <h3 class="text-sm font-medium text-slate-400">Maior Margem de Lucro</h3>
                             <p id="kpi-produto-maior-margem" class="text-xl font-bold mt-2 text-white truncate">N/A</p>
                        </div>
                        <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                             <h3 class="text-sm font-medium text-slate-400">Mais Complexo (Insumos)</h3>
                             <p id="kpi-produto-mais-complexo" class="text-xl font-bold mt-2 text-white truncate">N/A</p>
                        </div>
                        <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                             <h3 class="text-sm font-medium text-slate-400">Mais Rentável (Lucro Total)</h3>
                             <p id="kpi-produto-mais-rentavel" class="text-xl font-bold mt-2 text-white truncate">N/A</p>
                        </div>
                    </div>
                    <div class="flex justify-end mb-6">
                        <button id="btn-novo-produto" class="w-full md:w-auto bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700">Novo Produto</button>
                    </div>
                     <div id="lista-produtos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="produtos-form-view" class="hidden">
                    <h1 id="produto-form-titulo" class="text-3xl font-bold mb-6 text-white"></h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 bg-[#0f172a] border border-[#334155] p-6 rounded-xl h-fit">
                            <h2 class="text-xl font-semibold mb-4 text-white">Informações Básicas</h2>
                            <form id="form-produto">
                                <input type="hidden" id="produto-id">
                                <label class="block mb-4 text-center cursor-pointer">
                                    <img id="produto-imagem-preview" src="https://placehold.co/600x400/0f172a/e2e8f0?text=Foto+do+Produto" class="w-full h-40 object-cover rounded-md bg-[#020617]">
                                    <input type="file" id="produto-imagem" class="hidden" accept="image/*">
                                    <span class="text-sm text-blue-400 mt-1 block">Clique para enviar uma foto</span>
                                </label>
                                <input type="text" id="produto-nome" placeholder="Nome do produto" class="w-full p-2 border rounded-md mb-2" required>
                                <textarea id="produto-desc" placeholder="Descrição do produto" class="w-full p-2 border rounded-md mb-4 h-20"></textarea>
                                
                                <h4 class="font-semibold text-white mt-4 mb-2">Insumos de Produção</h4>
                                <div id="produto-insumos-lista" class="space-y-2 my-2 max-h-40 overflow-y-auto p-2 border border-[#334155] rounded-md bg-[#1e293b]"></div>
                                <div class="flex gap-2">
                                   <select id="select-insumo-para-produto" class="w-full p-2 border rounded-md"></select>
                                   <input type="number" step="0.001" id="qtd-insumo-para-produto" placeholder="Qtd" class="w-24 p-2 border rounded-md">
                                   <button type="button" id="btn-add-insumo-produto" class="bg-slate-600 text-slate-200 px-3 rounded-md font-bold hover:bg-slate-500">+</button>
                                </div>

                                <button type="submit" class="mt-8 w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Salvar Produto</button>
                                 <button type="button" id="btn-cancelar-produto" class="mt-2 w-full bg-slate-600 text-white p-2.5 rounded-md font-semibold hover:bg-slate-500">Cancelar</button>
                            </form>
                        </div>
                         <div class="lg:col-span-2 bg-[#0f172a] border border-[#334155] p-6 rounded-xl h-fit">
                            <h2 class="text-xl font-semibold mb-4 text-white">Precificação do Produto</h2>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-300">Custo de Insumos</span>
                                    <span id="produto-custo-insumos" class="font-bold">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-300">Custos por Venda (Embalagens, etc.)</span>
                                    <span id="produto-custo-venda" class="font-bold">R$ 0,00</span>
                                </div>
                                 <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-300">Custo Fixo Unitário</span>
                                    <span id="produto-custo-fixo" class="font-bold">R$ 0,00</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-slate-300">Custo de Mão de Obra</span>
                                    <span id="produto-custo-mao-de-obra" class="font-bold">R$ 0,00</span>
                                </div>
                                
                                <div class="p-3 bg-[#1e293b] border border-[#334155] rounded-md text-center">
                                    <span class="text-sm text-slate-300">Custo Total do Produto</span>
                                    <p id="produto-custo-total" class="font-bold text-xl text-amber-400">R$ 0,00</p>
                                </div>

                                <h4 class="font-semibold text-white pt-4 border-t border-slate-700">Taxas sobre a Venda (%)</h4>
                                <div id="produto-despesas-percentual-lista" class="space-y-2 mb-2"></div>
                                <div class="flex gap-2">
                                   <input type="text" id="produto-despesa-percentual-nome" placeholder="Ex: Taxa Marketplace" class="w-full p-2 border rounded-md">
                                   <input type="number" step="0.01" id="produto-despesa-percentual-valor" placeholder="%" class="w-24 p-2 border rounded-md">
                                   <button type="button" id="btn-add-despesa-percentual" class="bg-slate-600 text-slate-200 px-3 rounded-md font-bold hover:bg-slate-500">+</button>
                                </div>
                             
                                <div class="pt-4 border-t border-slate-700">
                                    <label class="block text-sm mb-1">Margem de Lucro: <span id="produto-margem-lucro-valor" class="font-bold text-blue-400">100%</span></label>
                                    <input type="range" id="produto-margem-lucro" min="0" max="300" value="100" class="w-full">
                                </div>
                             
                                <div class="mt-6 p-4 bg-green-900/50 border border-green-500/30 rounded-md text-center">
                                    <span class="text-sm text-green-200">Preço Final de Venda Sugerido</span>
                                    <p id="produto-preco-final" class="font-bold text-3xl text-green-300">R$ 0,00</p>
                                </div>
                            </div>
                         </div>
                    </div>
                </div>
            </section>

            <!-- Produção -->
            <section id="producao" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white hidden md:block">Registro de Produção</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-[#0f172a] border border-[#334155] p-6 rounded-xl h-fit">
                        <h2 class="text-xl font-semibold mb-4 text-white">Registrar Nova Produção</h2>
                        <form id="form-producao">
                            <label class="block text-sm mb-1">Selecione o Produto</label>
                            <select id="select-produto-producao" class="w-full p-2 border rounded-md mb-4" required></select>
                            <label class="block text-sm mb-1">Quantidade a Produzir</label>
                            <input type="number" id="qtd-produzida" placeholder="Qtd." class="w-full p-2 border rounded-md mb-4" required>
                            <button type="submit" class="w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Registrar Produção</button>
                        </form>
                        <div class="mt-6">
                            <h3 class="font-semibold mb-2 text-white">Análise de Insumos para Produção</h3>
                            <div id="producao-necessidades" class="space-y-2 max-h-48 overflow-y-auto p-2 border border-[#334155] rounded-md bg-[#1e293b]">
                                <p class="text-slate-400 text-sm">Selecione um produto e a quantidade.</p>
                            </div>
                        </div>
                    </div>
                     <div class="lg:col-span-2 bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="text-xl font-semibold text-white">Histórico de Produção</h2>
                             <button id="exportar-relatorio-producao" class="bg-blue-600 text-white p-2 rounded-md font-semibold text-sm hover:bg-blue-700 transition-all">Exportar Relatório</button>
                        </div>
                        <div class="max-h-[60vh] overflow-y-auto">
                            <table class="w-full text-left responsive-table">
                                <thead>
                                    <tr>
                                        <th class="p-2">Data</th>
                                        <th class="p-2">Produto</th>
                                        <th class="p-2">Qtd.</th>
                                        <th class="p-2">Custo Total</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-producao"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Estoque -->
            <section id="estoque" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white hidden md:block">Dashboard de Estoque</h1>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-white">Top 5 - Maior Estoque</h2>
                        <div id="estoque-alto" class="space-y-3"></div>
                    </div>
                    <div class="bg-[#0f172a] border border-[#334155] p-6 rounded-xl">
                        <h2 class="text-xl font-semibold mb-4 text-white">Top 5 - Menor Estoque</h2>
                        <div id="estoque-baixo" class="space-y-3"></div>
                    </div>
                </div>
            </section>

            <!-- Perfil -->
            <section id="perfil" class="tab-content">
                <h1 class="text-3xl font-bold mb-6 text-white hidden md:block">Perfil do Usuário</h1>
                <div class="max-w-2xl mx-auto bg-[#0f172a] border border-[#334155] p-8 rounded-xl">
                     <form id="form-perfil">
                        <div class="text-center mb-8">
                             <img id="perfil-imagem-preview" src="https://placehold.co/128x128/0f172a/e2e8f0?text=Logo" class="w-32 h-32 object-cover rounded-full bg-[#1e293b] mx-auto border-2 border-[#334155]">
                             <input type="file" id="perfil-imagem" class="hidden" accept="image/*">
                             <label for="perfil-imagem" class="cursor-pointer text-sm text-blue-400 mt-2 block">Alterar logo</label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Nome da Empresa</label>
                                <input type="text" id="perfil-empresa-nome" class="w-full p-2 border rounded-md">
                            </div>
                             <div>
                                <label class="block text-sm font-medium mb-1">E-mail de Contato</label>
                                <input type="email" id="perfil-email" class="w-full p-2 border rounded-md">
                            </div>
                        </div>
                         <div class="mt-4">
                            <label class="block text-sm font-medium mb-1">Informações Adicionais</label>
                            <textarea id="perfil-info" class="w-full p-2 border rounded-md h-24"></textarea>
                        </div>
                         <button type="submit" class="mt-6 w-full bg-white text-black p-2.5 rounded-md font-semibold hover:bg-gray-200 transition-all">Salvar Perfil</button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Barra de Navegação Mobile -->
    <nav id="bottom-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-[#0f172a] border-t border-[#334155] flex justify-around p-2 z-40">
        <a href="#dashboard" class="nav-link-mobile flex flex-col items-center justify-center text-xs text-slate-400 w-full rounded-md py-1">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            <span>Dashboard</span>
        </a>
        <a href="#custos" class="nav-link-mobile flex flex-col items-center justify-center text-xs text-slate-400 w-full rounded-md py-1">
            <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"></path></svg>
            <span>Custos</span>
        </a>
        <a href="#insumos" class="nav-link-mobile flex flex-col items-center justify-center text-xs text-slate-400 w-full rounded-md py-1">
             <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
            <span>Insumos</span>
        </a>
        <a href="#produtos" class="nav-link-mobile flex flex-col items-center justify-center text-xs text-slate-400 w-full rounded-md py-1">
             <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
            <span>Produtos</span>
        </a>
        <a href="#producao" class="nav-link-mobile flex flex-col items-center justify-center text-xs text-slate-400 w-full rounded-md py-1">
             <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span>Produção</span>
        </a>
    </nav>

    <!-- Modal para confirmação -->
    <div id="modal-confirmacao" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-[#0f172a] border border-[#334155] p-8 rounded-lg shadow-xl max-w-sm w-full">
            <h2 id="modal-titulo" class="text-xl font-bold mb-4 text-white"></h2>
            <p id="modal-mensagem" class="text-slate-300"></p>
            <div class="mt-6 flex justify-end gap-4">
                <button id="modal-btn-cancelar" class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-500">Cancelar</button>
                <button id="modal-btn-confirmar" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Calculadora de Custo Unitário -->
    <div id="modal-calculadora" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-[#0f172a] border border-[#334155] p-8 rounded-lg shadow-xl max-w-md w-full">
            <h2 id="calculadora-titulo" class="text-xl font-bold mb-6 text-white"></h2>
            <div class="space-y-4">
                <div>
                    <label class="text-sm">Custo Total do Pacote/Item</label>
                    <input type="number" step="0.01" id="calc-custo-total" placeholder="R$ 74,00" class="w-full p-2 border rounded-md mt-1">
                </div>
                <div>
                    <label class="text-sm">Quantidade Total do Pacote</label>
                    <input type="number" step="0.001" id="calc-qtd-total" placeholder="2.3" class="w-full p-2 border rounded-md mt-1">
                </div>
                <div>
                    <label class="text-sm">Rendimento Total (quantos itens você faz)</label>
                    <input type="number" id="calc-rendimento" placeholder="100" class="w-full p-2 border rounded-md mt-1">
                </div>
            </div>
            <div class="mt-6 p-4 bg-[#1e293b] rounded-md border border-[#334155] space-y-2">
                <h3 class="font-semibold text-white">Resultados por Unidade Produzida:</h3>
                <p class="text-sm">Custo por unidade: <span id="calc-resultado-custo-un" class="font-bold text-green-400">R$ 0,00</span></p>
                <p class="text-sm">Qtd. de insumo por unidade: <span id="calc-resultado-qtd-un" class="font-bold text-blue-400">0</span></p>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="modal-calculadora-fechar" class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-500">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>


    <!-- JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- ESTADO DA APLICAÇÃO ---
        let state = {
            perfil: {
                nomeEmpresa: 'Vexx',
                email: 'contato@vexx.com',
                info: '',
                imagem: 'https://placehold.co/128x128/0f172a/e2e8f0?text=V'
            },
            custos: {
                fixos: [
                    { id: 'fixo1', nome: 'Aluguel do Ateliê', valor: 1200 },
                    { id: 'fixo2', nome: 'Plano de Internet', valor: 99.90 },
                ],
                variaveis: [
                    { id: 'var1', nome: 'Energia Elétrica', valor: 250 },
                    { id: 'var2', nome: 'Conta de Água', valor: 80 }
                ],
                porVenda: [
                    { id: 'venda1', nome: 'Caixa de Envio P', valor: 1.50 },
                    { id: 'venda2', nome: 'Etiqueta de Agradecimento', valor: 0.25 }
                ],
                maoDeObra: {
                    salario: 3000,
                    horasDia: 8,
                    diasMes: 22,
                    pecasHora: 2
                },
                quantidadeEstimadaVendas: 200,
            },
            insumos: [
                { id: 'insumo1', nome: 'Solado Tradicional', desc: 'Solado para calçados do dia a dia.', preco: 7.50, estoque: 100, unidade: 'un', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Solado' },
                { id: 'insumo2', nome: 'Kit Solado Luxo', desc: 'Kit completo de solado de alta qualidade.', preco: 12.90, estoque: 50, unidade: 'un', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Solado+Luxo' },
                { id: 'insumo3', nome: 'Roletê Grosso', desc: 'Roletê de material resistente para alças.', preco: 1.20, estoque: 200, unidade: 'm', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Roletê' },
                { id: 'insumo4', nome: 'Roletê Fino', desc: 'Roletê de material fino para detalhes.', preco: 0.95, estoque: 300, unidade: 'm', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Roletê' },
                { id: 'insumo5', nome: 'Roletê Macarrão', desc: 'Roletê com formato de macarrão.', preco: 2.00, estoque: 150, unidade: 'm', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Roletê' },
                { id: 'insumo6', nome: 'Passante Fino', desc: 'Passante delicado para acabamentos.', preco: 0.50, estoque: 500, unidade: 'un', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Passante' },
                { id: 'insumo7', nome: 'Passante Grosso', desc: 'Passante resistente para estruturas.', preco: 0.60, estoque: 400, unidade: 'un', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Passante' },
                { id: 'insumo8', nome: 'Cola PVC', desc: 'Cola para PVC, preço por grama.', preco: 0.032, estoque: 2300, unidade: 'g', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Cola' },
                { id: 'insumo9', nome: 'Strass Fino', desc: 'Metro de strass fino para decoração.', preco: 3.50, estoque: 50, unidade: 'm', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Strass' },
                { id: 'insumo10', nome: 'Strass Grosso', desc: 'Metro de strass robusto para destaque.', preco: 5.50, estoque: 50, unidade: 'm', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Strass' },
                { id: 'insumo11', nome: 'Mangueirinha', desc: 'Metro de mangueirinha para detalhes.', preco: 4.00, estoque: 100, unidade: 'm', imagem: 'https://placehold.co/400x400/0f172a/e2e8f0?text=Mangueira' }
            ], 
            produtos: [],
            producao: [] 
        };

        // --- SELETORES DO DOM ---
        const navLinks = document.querySelectorAll('.nav-link');
        const mobileNavLinks = document.querySelectorAll('.nav-link-mobile');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // --- FUNÇÕES DE PERSISTÊNCIA ---
        const saveState = () => localStorage.setItem('vexxGestorState', JSON.stringify(state));
        const loadState = () => {
            const savedState = localStorage.getItem('vexxGestorState');
            if (savedState) {
                state = JSON.parse(savedState);
                state.perfil = state.perfil || { nomeEmpresa: 'Vexx', email: 'contato@vexx.com', info: '', imagem: 'https://placehold.co/128x128/0f172a/e2e8f0?text=V' };
                state.custos = state.custos || { fixos: [], variaveis: [], porVenda: [], maoDeObra: {}, quantidadeEstimadaVendas: 0 };
                state.insumos = state.insumos || [];
                state.produtos = state.produtos || [];
                state.producao = state.producao || [];
            }
        };

        // --- FUNÇÕES DE UI ---
        const toastContainer = document.getElementById('toast-container');
        const showToast = (message, type = 'success', duration = 3000) => {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        };

        const switchTab = (hash) => {
            hash = hash || '#dashboard';
            
            if (hash.startsWith("#produtos")) {
                showProdutosView('lista');
            }
            if (hash.startsWith("#insumos")) {
                showInsumosView('lista');
            }

            const allLinks = [...navLinks, ...mobileNavLinks];
            allLinks.forEach(link => {
                const linkHash = link.getAttribute('href');
                const isActive = (hash.startsWith(linkHash) && linkHash !== '#');
                link.classList.toggle('active', isActive);
                 if(link.classList.contains('nav-link-mobile')) {
                    link.classList.toggle('text-blue-400', isActive);
                    link.classList.toggle('text-slate-400', !isActive);
                 }
            });
            tabContents.forEach(content => {
                const contentHash = `#${content.id}`;
                const isActive = (hash.startsWith(contentHash) && contentHash !== '#');
                content.classList.toggle('active', isActive);
                content.classList.toggle('fade-in', isActive);
            });
        };

        [...navLinks, ...mobileNavLinks].forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.hash = e.currentTarget.getAttribute('href');
            });
        });
        
        window.addEventListener('hashchange', () => switchTab(window.location.hash));

        const generateId = () => `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);

        const showModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
        const hideModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
        
        const showConfirmationModal = (title, message, onConfirm) => {
            const modal = document.getElementById('modal-confirmacao');
            modal.querySelector('#modal-titulo').textContent = title;
            modal.querySelector('#modal-mensagem').textContent = message;
            showModal('modal-confirmacao');
            const confirmBtn = modal.querySelector('#modal-btn-confirmar');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.onclick = () => { onConfirm(); hideModal('modal-confirmacao'); };
            modal.querySelector('#modal-btn-cancelar').onclick = () => hideModal('modal-confirmacao');
        };

        // --- LÓGICA GERAL ---
        const saveAndRerender = () => {
            saveState();
            renderAll();
        };

        const renderAll = () => {
            renderDashboard();
            renderCustos();
            renderInsumos();
            renderProdutos();
            renderProducao();
            renderEstoque();
            renderPerfil();
        };

        // --- CÁLCULOS CHAVE (DEFINIDOS ANTES DE SEREM USADOS) ---
        const getCustoInsumosProduto = (insumosList = []) => {
            return insumosList.reduce((acc, item) => {
                const insumo = state.insumos.find(i => i.id === item.insumoId);
                const precoUnitarioInsumo = insumo ? insumo.preco : 0;
                return acc + (precoUnitarioInsumo * item.quantidade);
            }, 0);
        };
        
        const getCustoTotalMensal = () => {
             const custoFixoTotal = state.custos.fixos.reduce((a, d) => a + parseFloat(d.valor), 0);
             const custoVariavelTotal = state.custos.variaveis.reduce((a, d) => a + parseFloat(d.valor), 0);
             return custoFixoTotal + custoVariavelTotal;
        };
        
        const getCustoFixoUnitario = () => {
             const custoTotal = getCustoTotalMensal();
             const vendasEstimadas = state.custos.quantidadeEstimadaVendas || 0;
             return vendasEstimadas > 0 ? custoTotal / vendasEstimadas : 0;
        };
        
        const getCustoMaoDeObraUnitario = () => {
            const { salario = 0, horasDia = 0, diasMes = 0, pecasHora = 0 } = state.custos.maoDeObra;
            if (horasDia > 0 && diasMes > 0 && pecasHora > 0) {
                const custoHora = salario / (horasDia * diasMes);
                return custoHora / pecasHora;
            }
            return 0;
        };
        
        const getCustoPorVendaTotal = () => {
            return (state.custos.porVenda || []).reduce((acc, item) => acc + item.valor, 0);
        };

        const getCustoTotalUnitario = (produto) => {
            const custoInsumos = getCustoInsumosProduto(produto.insumos || []);
            const custoFixoUnit = getCustoFixoUnitario();
            const custoMaoDeObra = getCustoMaoDeObraUnitario();
            const custoVenda = getCustoPorVendaTotal();
            return custoInsumos + custoFixoUnit + custoMaoDeObra + custoVenda;
        };

        const getPrecoFinalProduto = (produto) => {
            const custoTotalUnitario = getCustoTotalUnitario(produto);
            const margem = produto.margemLucro / 100;
            const custoComLucro = custoTotalUnitario * (1 + margem);
            const totalPercentuais = (produto.percentuais || []).reduce((sum, p) => sum + p.valor, 0);
            if (totalPercentuais >= 100) return Infinity; 
            const precoFinal = custoComLucro / (1 - (totalPercentuais / 100));
            return precoFinal;
        };


        // --- LÓGICA DAS ABAS ---

        const renderDashboard = () => {
             document.getElementById('dashboard-custo-total').textContent = formatCurrency(getCustoTotalMensal());
             const inicioMes = new Date();
             inicioMes.setDate(1);
             inicioMes.setHours(0,0,0,0);
             const producaoMes = state.producao.filter(p => new Date(p.data) >= inicioMes);
             document.getElementById('dashboard-producao-mes').textContent = `${producaoMes.reduce((acc, p) => acc + p.quantidade, 0)} unidades`;
             
             const receitaEstimada = producaoMes.reduce((acc, reg) => {
                const produto = state.produtos.find(p => p.id === reg.produtoId);
                if (produto) {
                    const precoVenda = getPrecoFinalProduto(produto);
                    return acc + (precoVenda * reg.quantidade);
                }
                return acc;
             }, 0);
             document.getElementById('dashboard-receita-estimada').textContent = formatCurrency(receitaEstimada);

             const custoProducaoMes = producaoMes.reduce((acc, reg) => acc + reg.custoTotal, 0);
             const despesasPercentuaisMes = producaoMes.reduce((acc, reg) => {
                 const produto = state.produtos.find(p => p.id === reg.produtoId);
                 if (produto) {
                     const precoVenda = getPrecoFinalProduto(produto);
                     const totalPercentual = (produto.percentuais || []).reduce((sum, p) => sum + p.valor, 0);
                     return acc + (precoVenda * (totalPercentual / 100));
                 }
                 return acc;
             }, 0);

             document.getElementById('dashboard-lucro-estimado').textContent = formatCurrency(receitaEstimada - custoProducaoMes - despesasPercentuaisMes);

            const alertasContainer = document.getElementById('dashboard-alertas-estoque');
            alertasContainer.innerHTML = '';
            const insumosBaixoEstoque = state.insumos.filter(i => i.estoque <= 10);
            if (insumosBaixoEstoque.length > 0) {
                insumosBaixoEstoque.forEach(i => {
                    const p = document.createElement('p');
                    p.className = 'text-sm text-yellow-200 bg-yellow-900/50 border border-yellow-500/30 p-2 rounded-md';
                    p.textContent = `${i.nome}: Apenas ${i.estoque} ${i.unidade} em estoque.`;
                    alertasContainer.appendChild(p);
                });
            } else {
                alertasContainer.innerHTML = '<p class="text-slate-400">Nenhum alerta no momento.</p>';
            }
            const maisProduzidosContainer = document.getElementById('dashboard-mais-produzidos');
            maisProduzidosContainer.innerHTML = '';
            if (state.producao.length > 0) {
                const contagem = state.producao.reduce((acc, reg) => {
                    acc[reg.produtoId] = (acc[reg.produtoId] || 0) + reg.quantidade;
                    return acc;
                }, {});
                const sorted = Object.entries(contagem).sort(([,a],[,b]) => b-a).slice(0, 5);
                if (sorted.length === 0) {
                     maisProduzidosContainer.innerHTML = '<p class="text-slate-400">Nenhum produto produzido ainda.</p>';
                } else {
                    sorted.forEach(([produtoId, qtd]) => {
                         const produto = state.produtos.find(p => p.id === produtoId);
                         if(produto) {
                            const div = document.createElement('div');
                            div.className = 'flex justify-between text-sm';
                            div.innerHTML = `<span>${produto.nome}</span><span class="font-semibold">${qtd} un.</span>`;
                            maisProduzidosContainer.appendChild(div);
                         }
                    });
                }
            } else {
                maisProduzidosContainer.innerHTML = '<p class="text-slate-400">Nenhum produto registrado.</p>';
            }
        };

        const renderCustos = () => {
            // Renderiza listas de custos fixos e variáveis
            ['fixos', 'variaveis'].forEach(tipo => {
                const container = document.getElementById(`lista-custos-${tipo}`);
                container.innerHTML = '';
                if (state.custos[tipo].length === 0) {
                     container.innerHTML = `<p class="text-sm text-slate-400">Nenhuma despesa adicionada.</p>`
                } else {
                    state.custos[tipo].forEach(custo => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center bg-[#1e293b] p-2 rounded-md border border-[#334155]';
                        div.innerHTML = `<span>${custo.nome}</span>
                            <div class="flex items-center gap-3"><span class="font-semibold">${formatCurrency(custo.valor)}</span>
                            <button data-id="${custo.id}" data-tipo="${tipo}" class="text-red-400 hover:text-red-300 font-bold text-lg">&times;</button></div>`;
                        container.appendChild(div);
                    });
                }
            });
             // Renderiza lista de custos por venda
            const porVendaContainer = document.getElementById('lista-custos-venda');
            porVendaContainer.innerHTML = '';
             if ((state.custos.porVenda || []).length === 0) {
                porVendaContainer.innerHTML = `<p class="text-sm text-slate-400">Nenhum custo por venda adicionado.</p>`
            } else {
                state.custos.porVenda.forEach(custo => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-[#1e293b] p-2 rounded-md border border-[#334155]';
                    div.innerHTML = `<span>${custo.nome}</span>
                        <div class="flex items-center gap-3"><span class="font-semibold">${formatCurrency(custo.valor)}</span>
                        <button data-id="${custo.id}" data-tipo="porVenda" class="text-red-400 hover:text-red-300 font-bold text-lg">&times;</button></div>`;
                    porVendaContainer.appendChild(div);
                });
            }

            document.querySelectorAll('#custos button[data-id]').forEach(btn => {
                btn.onclick = (e) => {
                    const { id, tipo } = e.currentTarget.dataset;
                    showConfirmationModal('Excluir Custo', 'Tem certeza?', () => {
                        state.custos[tipo] = state.custos[tipo].filter(d => d.id !== id);
                        saveAndRerender(); showToast('Custo excluído!', 'info');
                    });
                };
            });
            
            // Popula campos
            document.getElementById('quantidade-estimada-vendas').value = state.custos.quantidadeEstimadaVendas || '';
            document.getElementById('mao-salario').value = state.custos.maoDeObra.salario || '';
            document.getElementById('mao-horas-dia').value = state.custos.maoDeObra.horasDia || '';
            document.getElementById('mao-dias-mes').value = state.custos.maoDeObra.diasMes || '';
            document.getElementById('mao-pecas-hora').value = state.custos.maoDeObra.pecasHora || '';

            // Renderiza resumos
            document.getElementById('resumo-custo-fixo').textContent = formatCurrency(getCustoFixoUnitario());
            document.getElementById('resumo-mao-de-obra').textContent = formatCurrency(getCustoMaoDeObraUnitario());
            document.getElementById('resumo-custo-venda').textContent = formatCurrency(getCustoPorVendaTotal());
        };
        
        const renderInsumos = () => {
            const lista = document.getElementById('lista-insumos');
            lista.innerHTML = state.insumos.length === 0 ? `<tr><td colspan="5" class="p-4 text-center text-slate-400">Nenhum insumo cadastrado.</td></tr>` : '';
            state.insumos.forEach(insumo => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-[#334155] align-middle';
                tr.innerHTML = `
                    <td data-label="Foto"><img src="${insumo.imagem}" alt="[Foto do insumo ${insumo.nome}]" class="w-10 h-10 rounded-md object-cover"></td>
                    <td data-label="Nome">${insumo.nome}</td>
                    <td data-label="Preço Unit.">${formatCurrency(insumo.preco)} / ${insumo.unidade}</td>
                    <td data-label="Estoque">${insumo.estoque} ${insumo.unidade}</td>
                    <td data-label="Ações" class="flex gap-2 items-center"><button data-edit-id="${insumo.id}" class="text-blue-400 hover:text-blue-300">Editar</button>
                    <button data-delete-id="${insumo.id}" class="text-red-400 hover:text-red-300">Excluir</button></td>`;
                lista.appendChild(tr);
            });
            document.querySelectorAll('#insumos [data-delete-id]').forEach(btn => {
                btn.onclick = e => showConfirmationModal('Excluir Insumo', 'Tem certeza? Isso pode afetar produtos.', () => {
                    const id = e.currentTarget.dataset.deleteId;
                    state.insumos = state.insumos.filter(i => i.id !== id);
                    state.produtos.forEach(p => p.insumos = p.insumos.filter(i => i.insumoId !== id));
                    saveAndRerender(); showToast('Insumo excluído.', 'info');
                });
            });
            document.querySelectorAll('#insumos [data-edit-id]').forEach(btn => {
                btn.onclick = e => {
                    const insumo = state.insumos.find(i => i.id === e.currentTarget.dataset.editId);
                    if (insumo) {
                        showInsumosView('form', insumo.id);
                    }
                };
            });
            populateInsumoSelects();
        };

        const renderProdutos = () => {
            const listaProdutos = document.getElementById('lista-produtos');
            listaProdutos.innerHTML = state.produtos.length === 0 ? `<p class="text-slate-400 md:col-span-3 text-center">Nenhum produto cadastrado.</p>` : '';
            state.produtos.forEach(produto => {
                const precoFinal = getPrecoFinalProduto(produto);
                const custoTotal = getCustoTotalUnitario(produto);

                const card = document.createElement('div');
                card.className = "bg-[#0f172a] border border-[#334155] rounded-xl overflow-hidden flex flex-col";
                card.innerHTML = `<img src="${produto.imagem}" alt="[Foto do ${produto.nome}]" class="w-full h-40 object-cover">
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="font-bold text-lg text-white">${produto.nome}</h3>
                        <p class="text-slate-400 text-sm mb-4 flex-grow">${produto.desc}</p>
                        <div class="text-xs space-y-1 mt-2">
                             <div class="flex justify-between"><span>Custo Total Unitário:</span> <span class="font-semibold">${formatCurrency(custoTotal)}</span></div>
                             <div class="flex justify-between"><span>Preço Final de Venda:</span> <span class="font-semibold text-green-400">${formatCurrency(precoFinal)}</span></div>
                        </div>
                         <div class="mt-4 flex gap-2">
                            <button data-edit-id="${produto.id}" class="w-full text-sm bg-blue-600 text-white p-2 rounded-md font-semibold hover:bg-blue-700">Editar</button>
                            <button data-delete-id="${produto.id}" class="w-full text-sm bg-red-600 text-white p-2 rounded-md font-semibold hover:bg-red-700">Excluir</button>
                        </div></div>`;
                listaProdutos.appendChild(card);
            });
            
            // Renderiza KPIs
            renderProdutoKPIs();

            document.querySelectorAll('#produtos [data-delete-id]').forEach(btn => {
                btn.onclick = e => showConfirmationModal('Excluir Produto', 'Tem certeza?', () => {
                    state.produtos = state.produtos.filter(p => p.id !== e.currentTarget.dataset.deleteId);
                    saveAndRerender(); showToast('Produto excluído!', 'info');
                });
            });
            document.querySelectorAll('#produtos [data-edit-id]').forEach(btn => {
                btn.onclick = e => {
                    const produto = state.produtos.find(p => p.id === e.currentTarget.dataset.editId);
                    if(produto) {
                        showProdutosView('form', produto.id);
                    }
                };
            });
            populateProdutoSelects();
        };
        
        const renderProdutoKPIs = () => {
            const maiorMargemEl = document.getElementById('kpi-produto-maior-margem');
            const maisComplexoEl = document.getElementById('kpi-produto-mais-complexo');
            const maisRentavelEl = document.getElementById('kpi-produto-mais-rentavel');

            if (state.produtos.length === 0) {
                maiorMargemEl.textContent = 'N/A';
                maisComplexoEl.textContent = 'N/A';
                maisRentavelEl.textContent = 'N/A';
                return;
            }

            // Maior Margem
            const produtoMaiorMargem = state.produtos.reduce((max, p) => p.margemLucro > max.margemLucro ? p : max, state.produtos[0]);
            maiorMargemEl.textContent = produtoMaiorMargem.nome;

            // Mais Complexo
            const produtoMaisComplexo = state.produtos.reduce((max, p) => (p.insumos || []).length > (max.insumos || []).length ? p : max, state.produtos[0]);
            maisComplexoEl.textContent = produtoMaisComplexo.nome;

            // Mais Rentável
            const lucros = state.producao.reduce((acc, reg) => {
                const produto = state.produtos.find(p => p.id === reg.produtoId);
                if (produto) {
                    const lucroPorUnidade = getPrecoFinalProduto(produto) - getCustoTotalUnitario(produto);
                    acc[produto.id] = (acc[produto.id] || 0) + (lucroPorUnidade * reg.quantidade);
                }
                return acc;
            }, {});

            if (Object.keys(lucros).length > 0) {
                const maisRentavelId = Object.keys(lucros).reduce((a, b) => lucros[a] > lucros[b] ? a : b);
                const produtoMaisRentavel = state.produtos.find(p => p.id === maisRentavelId);
                maisRentavelEl.textContent = produtoMaisRentavel.nome;
            } else {
                maisRentavelEl.textContent = 'Nenhuma produção';
            }
        };

        const renderProducao = () => {
             const lista = document.getElementById('lista-producao');
             lista.innerHTML = state.producao.length === 0 ? `<tr><td colspan="4" class="p-4 text-center text-slate-400">Nenhum registro de produção.</td></tr>` : '';
             [...state.producao].sort((a,b) => new Date(b.data) - new Date(a.data)).forEach(reg => {
                const produto = state.produtos.find(p => p.id === reg.produtoId);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-[#334155]';
                const custoRealDaProducao = produto ? getCustoTotalUnitario(produto) * reg.quantidade : 0;
                tr.innerHTML = `<td data-label="Data">${new Date(reg.data).toLocaleDateString('pt-BR')}</td>
                    <td data-label="Produto">${produto ? produto.nome : 'Produto não encontrado'}</td>
                    <td data-label="Qtd.">${reg.quantidade}</td><td data-label="Custo Total">${formatCurrency(custoRealDaProducao)}</td>`;
                lista.appendChild(tr);
             });
        };

        const renderEstoque = () => {
            const estoqueAltoContainer = document.getElementById('estoque-alto');
            const estoqueBaixoContainer = document.getElementById('estoque-baixo');
            estoqueAltoContainer.innerHTML = '';
            estoqueBaixoContainer.innerHTML = '';

            if (state.insumos.length === 0) {
                const msg = `<p class="text-slate-400 text-sm">Nenhum insumo cadastrado.</p>`;
                estoqueAltoContainer.innerHTML = msg;
                estoqueBaixoContainer.innerHTML = msg;
                return;
            }

            const sortedByStock = [...state.insumos].sort((a, b) => b.estoque - a.estoque);
            const top5 = sortedByStock.slice(0, 5);
            const bottom5 = sortedByStock.slice(-5).reverse();

            top5.forEach(insumo => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-[#1e293b] p-2 rounded-md';
                div.innerHTML = `<span>${insumo.nome}</span><span class="font-semibold text-green-400">${insumo.estoque} ${insumo.unidade}</span>`;
                estoqueAltoContainer.appendChild(div);
            });
            bottom5.forEach(insumo => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-[#1e293b] p-2 rounded-md';
                div.innerHTML = `<span>${insumo.nome}</span><span class="font-semibold text-yellow-400">${insumo.estoque} ${insumo.unidade}</span>`;
                estoqueBaixoContainer.appendChild(div);
            });
        };

        const renderPerfil = () => {
             document.getElementById('perfil-empresa-nome').value = state.perfil.nomeEmpresa;
             document.getElementById('perfil-email').value = state.perfil.email;
             document.getElementById('perfil-info').value = state.perfil.info;
             document.getElementById('perfil-imagem-preview').src = state.perfil.imagem;
        };

        let currentProdutoInsumos = []; 
        let currentProdutoPercentuais = [];

        const calculateProdutoPrecoFinal = () => {
             const custoInsumos = getCustoInsumosProduto(currentProdutoInsumos);
             const custoFixoUnit = getCustoFixoUnitario();
             const custoMaoDeObra = getCustoMaoDeObraUnitario();
             const custoVenda = getCustoPorVendaTotal();
             const custoTotalUnitario = custoInsumos + custoFixoUnit + custoMaoDeObra + custoVenda;
             
             document.getElementById('produto-custo-insumos').textContent = formatCurrency(custoInsumos);
             document.getElementById('produto-custo-venda').textContent = formatCurrency(custoVenda);
             document.getElementById('produto-custo-fixo').textContent = formatCurrency(custoFixoUnit);
             document.getElementById('produto-custo-mao-de-obra').textContent = formatCurrency(custoMaoDeObra);
             document.getElementById('produto-custo-total').textContent = formatCurrency(custoTotalUnitario);

            const margem = parseFloat(document.getElementById('produto-margem-lucro').value) / 100;
            const custoComLucro = custoTotalUnitario * (1 + margem);
            const totalPercentuais = currentProdutoPercentuais.reduce((sum, p) => sum + p.valor, 0);

            let precoFinal = custoComLucro;
            if (totalPercentuais < 100) {
                precoFinal = custoComLucro / (1 - (totalPercentuais / 100));
            }
            
            document.getElementById('produto-preco-final').textContent = formatCurrency(precoFinal);
        };
        
        const renderProdutoInsumosList = () => {
            const container = document.getElementById('produto-insumos-lista');
            container.innerHTML = (currentProdutoInsumos.length === 0) ? '<p class="text-slate-400 text-sm">Nenhum insumo de produção.</p>' : '';
            currentProdutoInsumos.forEach(item => {
                const insumoData = state.insumos.find(i => i.id === item.insumoId);
                if (insumoData) {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-sm bg-slate-900 p-1.5 rounded';
                    div.innerHTML = `<span>${insumoData.nome} (${item.quantidade} ${insumoData.unidade})</span>
                        <button type="button" data-id="${item.insumoId}" class="text-red-400 font-bold px-2">&times;</button>`;
                    container.appendChild(div);
                }
            });
            container.querySelectorAll('button').forEach(btn => {
                btn.onclick = e => {
                    currentProdutoInsumos = currentProdutoInsumos.filter(i => i.insumoId !== e.currentTarget.dataset.id);
                    renderProdutoInsumosList(); calculateProdutoPrecoFinal();
                };
            });
        };
        
        const renderProdutoPercentuaisList = () => {
            const container = document.getElementById('produto-despesas-percentual-lista');
            container.innerHTML = (currentProdutoPercentuais.length === 0) ? '<p class="text-slate-400 text-sm">Nenhuma taxa sobre venda.</p>' : '';
            currentProdutoPercentuais.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center text-sm bg-slate-900 p-1.5 rounded';
                div.innerHTML = `<span>${item.nome} (${item.valor}%)</span>
                    <button type="button" data-id="${item.id}" class="text-red-400 font-bold px-2">&times;</button>`;
                container.appendChild(div);
            });
            container.querySelectorAll('button').forEach(btn => {
                btn.onclick = e => {
                    currentProdutoPercentuais = currentProdutoPercentuais.filter(i => i.id !== e.currentTarget.dataset.id);
                    renderProdutoPercentuaisList(); calculateProdutoPrecoFinal();
                };
            });
        }

        const updateProducaoNecessidades = () => {
            const container = document.getElementById('producao-necessidades');
            const produtoId = document.getElementById('select-produto-producao').value;
            const quantidade = parseFloat(document.getElementById('qtd-produzida').value);
            container.innerHTML = '';

            if (!produtoId || !quantidade || quantidade <= 0) {
                container.innerHTML = '<p class="text-slate-400 text-sm">Selecione um produto e a quantidade.</p>';
                return;
            }

            const produto = state.produtos.find(p => p.id === produtoId);
            if (!produto) return;

            if (produto.insumos.length === 0) {
                container.innerHTML = '<p class="text-slate-400 text-sm">Este produto não possui insumos cadastrados.</p>';
                return;
            }

            produto.insumos.forEach(item => {
                const insumoData = state.insumos.find(i => i.id === item.insumoId);
                if (insumoData) {
                    const necessario = item.quantidade * quantidade;
                    const disponivel = insumoData.estoque;
                    const statusOk = disponivel >= necessario;
                    const div = document.createElement('div');
                    div.className = `p-2 rounded-md text-sm ${statusOk ? 'bg-green-900/50' : 'bg-red-900/50'}`;
                    div.innerHTML = `<div class="font-bold">${insumoData.nome}</div>
                        <div>Necessário: ${necessario.toFixed(3)} ${insumoData.unidade}</div>
                        <div>Disponível: ${disponivel.toFixed(3)} ${insumoData.unidade}</div>
                        <div class="font-bold mt-1 ${statusOk ? 'text-green-400' : 'text-red-400'}">
                            ${statusOk ? 'ESTOQUE OK' : `FALTAM ${(necessario - disponivel).toFixed(3)} ${insumoData.unidade}`}
                        </div>`;
                    container.appendChild(div);
                }
            });
        };
        
        const showInsumosView = (view, insumoId = null) => {
            const listView = document.getElementById('insumo-list-container');
            const formView = document.getElementById('insumo-form-container');
            
            if (window.innerWidth < 768) { // Mobile view
                 if (view === 'form') {
                    listView.classList.add('hidden');
                    formView.classList.remove('hidden');
                    formView.classList.remove('lg:col-span-1');
                 } else {
                    listView.classList.remove('hidden');
                    formView.classList.add('hidden');
                 }
            } else { // Desktop view
                listView.classList.remove('hidden');
                formView.classList.remove('hidden');
                formView.classList.add('lg:col-span-1');
            }

            // Populate form if editing
            if (view === 'form' && insumoId) {
                const insumo = state.insumos.find(i => i.id === insumoId);
                if (insumo) {
                    document.getElementById('insumo-id').value = insumo.id;
                    document.getElementById('insumo-imagem-preview').src = insumo.imagem;
                    document.getElementById('insumo-nome').value = insumo.nome;
                    document.getElementById('insumo-desc').value = insumo.desc;
                    document.getElementById('insumo-preco').value = insumo.preco;
                    document.getElementById('insumo-estoque').value = insumo.estoque;
                    document.getElementById('insumo-unidade').value = insumo.unidade;
                }
            }
        };


        const showProdutosView = (view, produtoId = null) => {
            const listView = document.getElementById('produtos-lista-view');
            const formView = document.getElementById('produtos-form-view');
            const formTitle = document.getElementById('produto-form-titulo');

            if (view === 'form') {
                listView.classList.add('hidden');
                formView.classList.remove('hidden');
                
                const form = document.getElementById('form-produto');
                form.reset();
                document.getElementById('produto-id').value = '';
                document.getElementById('produto-imagem-preview').src = 'https://placehold.co/600x400/0f172a/e2e8f0?text=Foto+do+Produto';
                currentProdutoInsumos = [];
                currentProdutoPercentuais = [];

                if (produtoId) {
                    formTitle.textContent = 'Editar Produto';
                    const produto = state.produtos.find(p => p.id === produtoId);
                    if (produto) {
                        document.getElementById('produto-id').value = produto.id;
                        document.getElementById('produto-nome').value = produto.nome;
                        document.getElementById('produto-desc').value = produto.desc;
                        document.getElementById('produto-imagem-preview').src = produto.imagem;
                        const margemInput = document.getElementById('produto-margem-lucro');
                        margemInput.value = produto.margemLucro;
                        document.getElementById('produto-margem-lucro-valor').textContent = `${produto.margemLucro}%`;
                        currentProdutoInsumos = JSON.parse(JSON.stringify(produto.insumos || []));
                        currentProdutoPercentuais = JSON.parse(JSON.stringify(produto.percentuais || []));
                    }
                } else {
                    formTitle.textContent = 'Novo Produto';
                    document.getElementById('produto-margem-lucro').value = 100;
                    document.getElementById('produto-margem-lucro-valor').textContent = '100%';
                }
                renderProdutoInsumosList();
                renderProdutoPercentuaisList();
                calculateProdutoPrecoFinal();

            } else { // 'lista' view
                listView.classList.remove('hidden');
                formView.classList.add('hidden');
            }
        };
        
        // --- EVENT LISTENERS ---
        document.getElementById('btn-novo-insumo-mobile').onclick = () => showInsumosView('form');
        document.getElementById('btn-cancelar-insumo').onclick = () => showInsumosView('lista');
        document.getElementById('btn-novo-produto').onclick = () => showProdutosView('form');
        document.getElementById('btn-cancelar-produto').onclick = () => showProdutosView('lista');


        ['fixo', 'variavel'].forEach(type => {
            document.getElementById(`form-custo-${type}`).addEventListener('submit', (e) => {
                e.preventDefault();
                const nome = document.getElementById(`${type}-nome`).value;
                const valor = parseFloat(document.getElementById(`${type}-valor`).value);
                const targetArray = type === 'fixo' ? state.custos.fixos : state.custos.variaveis;
                if (nome && valor > 0) {
                    targetArray.push({ id: generateId(), nome, valor });
                    e.target.reset(); saveAndRerender(); showToast('Custo adicionado!', 'success');
                }
            });
        });

        document.getElementById('form-custo-venda').addEventListener('submit', (e) => {
            e.preventDefault();
            const nome = document.getElementById('custo-venda-nome').value;
            const valor = parseFloat(document.getElementById('custo-venda-valor').value);
            if (nome && valor > 0) {
                state.custos.porVenda.push({ id: generateId(), nome, valor });
                e.target.reset(); saveAndRerender(); showToast('Custo por Venda adicionado!', 'success');
            }
        });

        document.getElementById('quantidade-estimada-vendas').addEventListener('input', (e) => {
            state.custos.quantidadeEstimadaVendas = parseFloat(e.target.value) || 0;
            renderAll();
        });
        document.getElementById('quantidade-estimada-vendas').addEventListener('blur', saveState);

        ['mao-salario', 'mao-horas-dia', 'mao-dias-mes', 'mao-pecas-hora'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                const key = id.replace('mao-', '');
                state.custos.maoDeObra[key] = parseFloat(e.target.value) || 0;
                renderAll();
            });
            document.getElementById(id).addEventListener('blur', saveState);
        });

        document.getElementById('form-insumo').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('insumo-id').value;
            const insumoData = {
                nome: document.getElementById('insumo-nome').value, desc: document.getElementById('insumo-desc').value,
                preco: parseFloat(document.getElementById('insumo-preco').value), estoque: parseFloat(document.getElementById('insumo-estoque').value),
                unidade: document.getElementById('insumo-unidade').value,
                imagem: document.getElementById('insumo-imagem-preview').src
            };
            if (id) {
                const index = state.insumos.findIndex(i => i.id === id);
                state.insumos[index] = { ...state.insumos[index], ...insumoData };
                showToast('Insumo atualizado!', 'success');
            } else {
                state.insumos.push({ id: generateId(), ...insumoData, imagem: insumoData.imagem || 'https://placehold.co/600x400/0f172a/e2e8f0?text=Foto+do+Insumo' });
                showToast('Insumo adicionado!', 'success');
            }
            e.target.reset();
            document.getElementById('insumo-id').value = '';
            document.getElementById('insumo-imagem-preview').src = 'https://placehold.co/600x400/0f172a/e2e8f0?text=Foto+do+Insumo';
            showInsumosView('lista');
            saveAndRerender();
        });

        document.getElementById('form-produto').addEventListener('submit', (e) => {
            e.preventDefault();
            const produtoId = document.getElementById('produto-id').value;
            const produtoData = {
                nome: document.getElementById('produto-nome').value, desc: document.getElementById('produto-desc').value,
                imagem: document.getElementById('produto-imagem-preview').src, 
                insumos: currentProdutoInsumos,
                margemLucro: parseFloat(document.getElementById('produto-margem-lucro').value),
                percentuais: currentProdutoPercentuais
            };
            if (produtoId) {
                const index = state.produtos.findIndex(p => p.id === produtoId);
                state.produtos[index] = { ...state.produtos[index], ...produtoData };
                showToast('Produto atualizado!', 'success');
            } else {
                state.produtos.push({ id: generateId(), ...produtoData });
                showToast('Produto adicionado!', 'success');
            }
            showProdutosView('lista');
            saveAndRerender();
        });
        
        document.getElementById('btn-add-insumo-produto').addEventListener('click', () => {
            const insumoId = document.getElementById('select-insumo-para-produto').value;
            const quantidade = parseFloat(document.getElementById('qtd-insumo-para-produto').value);
            if (insumoId && quantidade > 0 && !currentProdutoInsumos.some(i => i.insumoId === insumoId)) {
                currentProdutoInsumos.push({ insumoId, quantidade });
                renderProdutoInsumosList(); calculateProdutoPrecoFinal();
                document.getElementById('qtd-insumo-para-produto').value = '';
            }
        });
        
        document.getElementById('btn-add-despesa-percentual').addEventListener('click', () => {
            const nomeInput = document.getElementById('produto-despesa-percentual-nome');
            const valorInput = document.getElementById('produto-despesa-percentual-valor');
            const nome = nomeInput.value;
            const valor = parseFloat(valorInput.value);
            if (nome && valor > 0) {
                currentProdutoPercentuais.push({ id: generateId(), nome, valor });
                renderProdutoPercentuaisList(); calculateProdutoPrecoFinal();
                nomeInput.value = '';
                valorInput.value = '';
            }
        });
        
        const margemSlider = document.getElementById('produto-margem-lucro');
        const margemValorDisplay = document.getElementById('produto-margem-lucro-valor');
        margemSlider.addEventListener('input', () => {
            margemValorDisplay.textContent = `${margemSlider.value}%`;
            calculateProdutoPrecoFinal();
        });

        document.getElementById('form-producao').addEventListener('submit', (e) => {
            e.preventDefault();
            const produtoId = document.getElementById('select-produto-producao').value;
            const quantidade = parseFloat(document.getElementById('qtd-produzida').value);
            const produto = state.produtos.find(p => p.id === produtoId);
            if(!produto || !quantidade || quantidade <= 0) { showToast('Dados de produção inválidos.', 'error'); return; }
            const insumosFaltando = produto.insumos.map(item => ({...state.insumos.find(i => i.id === item.insumoId), necessario: item.quantidade * quantidade })).filter(insumo => !insumo.id || insumo.estoque < insumo.necessario);
            if (insumosFaltando.length > 0) { showToast(`Estoque insuficiente para: ${insumosFaltando.map(i => i.nome).join(', ')}`, 'error'); return; }
            produto.insumos.forEach(item => { state.insumos.find(i => i.id === item.insumoId).estoque -= item.quantidade * quantidade; });
            state.producao.push({ id: generateId(), produtoId: produtoId, quantidade: quantidade, data: new Date().toISOString(), custoTotal: getCustoTotalUnitario(produto) * quantidade });
            e.target.reset(); saveAndRerender(); showToast('Produção registrada!', 'success');
        });
        
        document.getElementById('select-produto-producao').addEventListener('input', updateProducaoNecessidades);
        document.getElementById('qtd-produzida').addEventListener('input', updateProducaoNecessidades);

        document.getElementById('form-perfil').addEventListener('submit', (e) => {
            e.preventDefault();
            state.perfil.nomeEmpresa = document.getElementById('perfil-empresa-nome').value;
            state.perfil.email = document.getElementById('perfil-email').value;
            state.perfil.info = document.getElementById('perfil-info').value;
            state.perfil.imagem = document.getElementById('perfil-imagem-preview').src;
            saveAndRerender(); showToast('Perfil salvo!', 'success');
        });

        // Calculadora Logic
        const setupCalculatorModal = (title) => {
            document.getElementById('calculadora-titulo').textContent = title;
            document.getElementById('modal-calculadora-fechar').onclick = () => hideModal('modal-calculadora');
            const calcInputs = ['calc-custo-total', 'calc-qtd-total', 'calc-rendimento'];
            calcInputs.forEach(id => {
                const input = document.getElementById(id);
                input.value = ''; // Clear previous values
                input.oninput = () => {
                    const custo = parseFloat(document.getElementById('calc-custo-total').value) || 0;
                    const qtd = parseFloat(document.getElementById('calc-qtd-total').value) || 0;
                    const rendimento = parseFloat(document.getElementById('calc-rendimento').value) || 0;
                    if (rendimento > 0) {
                        document.getElementById('calc-resultado-custo-un').textContent = formatCurrency(custo / rendimento);
                        document.getElementById('calc-resultado-qtd-un').textContent = `${(qtd / rendimento).toFixed(4)}`;
                    } else {
                         document.getElementById('calc-resultado-custo-un').textContent = formatCurrency(0);
                         document.getElementById('calc-resultado-qtd-un').textContent = `0`;
                    }
                }
            });
            showModal('modal-calculadora');
        }
        document.getElementById('custo-venda-calculadora').onclick = () => setupCalculatorModal('Calculadora de Custo por Venda');
        
        const populateInsumoSelects = () => {
            const select = document.getElementById('select-insumo-para-produto');
            select.innerHTML = '<option value="">Selecione um insumo...</option>';
            state.insumos.forEach(insumo => select.innerHTML += `<option value="${insumo.id}">${insumo.nome} (${insumo.unidade})</option>`);
        };
        const populateProdutoSelects = () => {
             const select = document.getElementById('select-produto-producao');
             select.innerHTML = '<option value="">Selecione um produto...</option>';
             state.produtos.forEach(produto => select.innerHTML += `<option value="${produto.id}">${produto.nome}</option>`);
        };
        const handleImageUpload = (inputId, previewId) => {
             document.getElementById(inputId).onchange = e => {
                 const file = e.target.files[0];
                 if (file) { const reader = new FileReader(); reader.onload = ev => document.getElementById(previewId).src = ev.target.result; reader.readAsDataURL(file); }
             };
        };
        handleImageUpload('produto-imagem', 'produto-imagem-preview');
        handleImageUpload('insumo-imagem', 'insumo-imagem-preview');
        handleImageUpload('perfil-imagem', 'perfil-imagem-preview');
        
        // --- INICIALIZAÇÃO ---
        loadState();
        switchTab(window.location.hash || '#dashboard');
        renderAll();

    });
    </script>
</body>
</html>
